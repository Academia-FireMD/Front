<div class="horarios-admin-container">
  <div class="grid">
    <div class="col-12 lg:col-4">
      <div class="card calendar-card sticky-calendar">
        <app-calendario-horarios
          [diasEstados]="diasEstados()"
          [modoMultiSeleccion]="modoCreacion()"
          [fechasExternas]="fechasSeleccionadasHorarios()"
          [fechaExterna]="!modoCreacion() ? fechaSeleccionada() : null"
          (fechaSeleccionada)="onFechaSeleccionada($event)"
          (fechasSeleccionadas)="onFechasSeleccionadas($event)"
        >
        </app-calendario-horarios>

        <div class="modo-selector mt-3">
          <p-selectButton
            [options]="modoOpciones"
            [ngModel]="modoCreacion()"
            (ngModelChange)="modoCreacion.set($event)"
            optionLabel="label"
            optionValue="value"
            [style]="{ width: '100%' }"
          >
          </p-selectButton>
        </div>

        <div class="leyenda-compacta mt-3">
          <div class="leyenda-item">
            <span class="dot disponible"></span>
            <span>Disponible</span>
          </div>
          <div class="leyenda-item">
            <span class="dot parcial"></span>
            <span>Parcial</span>
          </div>
          <div class="leyenda-item">
            <span class="dot completo"></span>
            <span>Completo</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 lg:col-8">
      <!-- MODO CREACIÓN -->
      @if (modoCreacion()) {
      <div class="card">
        <div class="flex align-items-center justify-content-between mb-3">
          <h3 class="m-0">Crear Horarios</h3>
          <p-chip
            [label]="fechasSeleccionadasHorarios().length + ' días'"
            icon="pi pi-calendar"
          ></p-chip>
        </div>

        <div class="grid mb-3" style="align-items: self-end">
          <div class="col-12 md:col-3">
            <label class="text-sm font-semibold mb-2 block">Inicio</label>
            <p-dropdown
              [options]="horas"
              [ngModel]="horaInicio()"
              (ngModelChange)="horaInicio.set($event)"
              optionLabel="label"
              optionValue="value"
              [style]="{ width: '100%' }"
            >
            </p-dropdown>
          </div>
          <div class="col-12 md:col-3">
            <label class="text-sm font-semibold mb-2 block">Fin</label>
            <p-dropdown
              [options]="horas"
              [ngModel]="horaFin()"
              (ngModelChange)="horaFin.set($event)"
              optionLabel="label"
              optionValue="value"
              [style]="{ width: '100%' }"
            >
            </p-dropdown>
          </div>
          <div class="col-12 md:col-3">
            <label class="text-sm font-semibold mb-2 block">Capacidad</label>
            <p-inputNumber class="w-full"
              [ngModel]="capacidad()"
              (ngModelChange)="capacidad.set($event)"
              [min]="1"
              [showButtons]="true"
              styleClass="w-full"
              [style]="{ width: '100%' }"
            >
            </p-inputNumber>
          </div>
          <div class="col-12 md:col-3 flex align-items-end">
            <app-async-button
              [action]="establecerHorarios"
              [disabled]="totalHorariosACrear() === 0"
              styleClass="p-button-primary"
              [style]="{ width: '100%' }"
              label="Crear horarios"
            >
            </app-async-button>
          </div>
        </div>

        @if (vistaPreviaHorarios(); as vp) {
        <div class="preview-compact p-3 surface-100 border-round">
          <div class="flex align-items-center justify-content-between mb-2">
            <span class="text-sm">
              <i class="pi pi-info-circle mr-2"></i>
              <strong>{{ totalHorariosACrear() }}</strong> nuevos ·
              <strong>{{ vp.horariosExistentes.length }}</strong> ya existen
            </span>
          </div>
          <div class="preview-detalle mt-3 pt-3 border-top-1 surface-border">
            @if (vp.horariosNuevos.length > 0) {
            <div class="mb-2">
              <span class="text-xs font-semibold text-primary">
                <i class="pi pi-plus-circle mr-1"></i>
                A crear:
              </span>
              <div class="horarios-badges-container mt-1">
                @for (horario of vp.horariosNuevos; track horario.horaInicioStr)
                {
                <span class="horario-badge-sm nuevo"
                  >{{ horario.horaInicioStr }}-{{ horario.horaFinStr }}</span
                >
                }
              </div>
            </div>
            } @if (vp.horariosExistentes.length > 0) {
            <div>
              <span class="text-xs font-semibold text-color-secondary">
                <i class="pi pi-check mr-1"></i>
                Ya existen:
              </span>
              <div class="horarios-badges-container mt-1">
                @for (horario of vp.horariosExistentes; track
                horario.horaInicioStr) {
                <span class="horario-badge-sm existente"
                  >{{ horario.horaInicioStr }}-{{ horario.horaFinStr }}</span
                >
                }
              </div>
            </div>
            }
          </div>
        </div>
        }
      </div>
      }

      <!-- MODO VER -->
      @if (!modoCreacion()) {
      <div class="card">
        <div
          class="flex align-items-center justify-content-between mb-3 flex-wrap gap-2"
        >
          <h3 class="m-0">
            @if (fechaSeleccionada()) {
            {{ fechaSeleccionada() | date : "d MMM yyyy" : "" : "es-ES" }}
            } @else { Todos los horarios }
          </h3>

          <div class="flex gap-2 align-items-center flex-wrap">
            @if (fechaSeleccionada()) {
            <p-button
              icon="pi pi-filter-slash"
              [text]="true"
              size="small"
              (click)="limpiarFiltroFecha()"
              pTooltip="Ver todos"
            >
            </p-button>
            }
            <p-button
              [icon]="
                mostrarHorariosPasados() ? 'pi pi-eye-slash' : 'pi pi-eye'
              "
              [outlined]="!mostrarHorariosPasados()"
              size="small"
              (click)="togglePasados()"
              [pTooltip]="
                mostrarHorariosPasados() ? 'Ocultar pasados' : 'Mostrar pasados'
              "
            >
            </p-button>
            @if (horariosSeleccionadosEliminar().length > 0) {
            <app-async-button
              [label]="horariosSeleccionadosEliminar().length + ''"
              icon="pi pi-trash"
              [action]="eliminarHorariosSeleccionados"
              styleClass="p-button-danger p-button-sm"
            >
            </app-async-button>
            }
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Buscador -->
        <div class="flex align-items-center gap-2 mb-3">
          <input
            type="text"
            pInputText
            placeholder="Buscar alumno..."
            [ngModel]="busquedaAlumno()"
            (ngModelChange)="busquedaAlumno.set($event)"
            class="w-full"
          />

          <div class="flex align-items-center justify-content-end">
            <p-button
              icon="pi pi-check"
              [rounded]="true"
              size="small"
              severity="success"
              (click)="confirmarReservas()"
              [disabled]="reservasSeleccionadas().length === 0"
              pTooltip="Confirmar seleccionadas"
            >
            </p-button>
            <p-button
              icon="pi pi-times"
              [rounded]="true"
              size="small"
              severity="danger"
              (click)="abrirDialogCancelacion()"
              [disabled]="reservasSeleccionadas().length === 0"
              pTooltip="Cancelar seleccionadas"
            >
            </p-button>
          </div>
        </div>

        <!-- Tabla unificada -->
        @if (horariosConReservas().length > 0) {
        <div class="horarios-tabla-unificada">
          @for (item of horariosConReservas(); track item.horario.id) {
          <div
            class="horario-row mb-3 p-3 border-1 surface-border border-round-md"
            [class.horario-seleccionado]="
              horariosSeleccionadosEliminar().includes(item.horario.id)
            "
          >
            <!-- Header del horario -->
            <div
              class="horario-header flex align-items-center justify-content-between mb-3 pb-2 border-bottom-1 surface-border"
            >
              <div class="flex align-items-center gap-2 flex-1">
                <p-checkbox
                  [binary]="true"
                  [ngModel]="
                    horariosSeleccionadosEliminar().includes(item.horario.id)
                  "
                  (onChange)="toggleHorarioEliminar(item.horario.id)"
                >
                </p-checkbox>
                <span class="font-semibold text-lg">{{
                  item.horario.horaInicio | date : "HH:mm"
                }}</span>
                <span class="text-color-secondary">-</span>
                <span class="font-semibold">{{
                  item.horario.horaFin | date : "HH:mm"
                }}</span>
                <p-tag
                  [value]="
                    getDisponibles(item.horario) + '/' + item.horario.capacidad
                  "
                  [severity]="
                    getDisponibles(item.horario) === 0
                      ? 'danger'
                      : getDisponibles(item.horario) < item.horario.capacidad
                      ? 'warning'
                      : 'success'
                  "
                >
                </p-tag>
                @if (esHorarioPasado(item.horario)) {
                <p-tag
                  value="Pasado"
                  severity="secondary"
                  [style]="{ fontSize: '0.75rem' }"
                ></p-tag>
                }
              </div>
              <div class="flex gap-1">
                @if (!esHorarioPasado(item.horario)) {
                <p-button
                  icon="pi pi-pencil"
                  [text]="true"
                  size="small"
                  (click)="abrirDialogEditar(item.horario)"
                  pTooltip="Editar horario"
                ></p-button>
                }
                <p-button
                  icon="pi pi-trash"
                  [text]="true"
                  severity="danger"
                  size="small"
                  (click)="confirmarEliminarHorario(item.horario)"
                  pTooltip="Eliminar horario"
                ></p-button>
              </div>
            </div>

            <!-- Reservas del horario -->
            <div class="reservas-del-horario">
              @if (item.reservas.length > 0) { @for (reserva of item.reservas;
              track reserva.id) {
              <div
                class="reserva-item mb-2 p-2 surface-50 border-round"
                [class.reserva-seleccionada]="
                  reservasSeleccionadas().includes(reserva.id)
                "
              >
                <div class="flex align-items-start gap-2">
                  <p-checkbox
                    [binary]="true"
                    [ngModel]="reservasSeleccionadas().includes(reserva.id)"
                    (onChange)="toggleReservaSeleccionada(reserva.id)"
                    [disabled]="!puedeCambiarEstado(reserva)"
                    [pTooltip]="
                      !puedeCambiarEstado(reserva)
                        ? getTooltipCheckboxReserva(reserva)
                        : ''
                    "
                    tooltipPosition="top"
                  >
                  </p-checkbox>
                  <div class="flex-1">
                    <div
                      class="flex align-items-center justify-content-between mb-1"
                    >
                      <span class="font-semibold"
                        >{{ reserva.alumno?.nombre }}
                        {{ reserva.alumno?.apellidos }}</span
                      >
                      <p-tag
                        [value]="getEstadoLabel(reserva.estado)"
                        [severity]="getEstadoSeverity(reserva.estado)"
                        [pTooltip]="getEstadoTooltip(reserva.estado)"
                        tooltipPosition="top"
                        [style]="{ fontSize: '0.75rem' }"
                      >
                      </p-tag>
                    </div>
                    <div class="text-sm text-color-secondary mb-1">
                      <i class="pi pi-envelope mr-1"></i>
                      {{ reserva.alumno?.email }}
                    </div>
                    @if (reserva.estado === EstadoReserva.CONFIRMADA) {
                    <div class="flex gap-1 mt-2">
                      <app-async-button
                        label="Completada"
                        icon="pi pi-check"
                        size="small"
                        [action]="getMarcarCompletadaAction(reserva.id)"
                        styleClass="p-button-success p-button-outlined p-button-sm"
                        [style]="{
                          fontSize: '0.75rem',
                          padding: '0.35rem 0.6rem'
                        }"
                      >
                      </app-async-button>
                      <app-async-button
                        label="Ausente"
                        icon="pi pi-user-minus"
                        size="small"
                        [action]="getMarcarAusenteAction(reserva.id)"
                        styleClass="p-button-warning p-button-outlined p-button-sm"
                        [style]="{
                          fontSize: '0.75rem',
                          padding: '0.35rem 0.6rem'
                        }"
                      >
                      </app-async-button>
                    </div>
                    } @if (reserva.estado === EstadoReserva.CANCELADA) {
                    <div class="mt-2 p-2 surface-100 border-round">
                      @if (reserva.canceladoPor) {
                      <div class="text-xs text-color-secondary mb-1">
                        <strong>Cancelado por:</strong>
                        {{ reserva.canceladoPor.nombre }}
                        {{ reserva.canceladoPor.apellidos }}
                      </div>
                      } @if (reserva.motivoCancelacion) {
                      <div class="text-xs text-color-secondary">
                        <strong>Motivo:</strong> {{ reserva.motivoCancelacion }}
                      </div>
                      }
                    </div>
                    }
                  </div>
                </div>
              </div>
              } } @else {
              <div class="text-center text-color-secondary py-2">
                <span class="text-sm">Sin reservas</span>
              </div>
              }
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="text-center text-color-secondary py-5">
          <i class="pi pi-clock text-5xl mb-3 block"></i>
          <p>No hay horarios</p>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>

<p-dialog
  header="Motivo de Cancelación"
  [visible]="mostrarDialogCancelacion()"
  (visibleChange)="mostrarDialogCancelacion.set($event)"
  [modal]="true"
  [style]="{ width: '450px' }"
>
  <div class="p-fluid">
    <div class="field">
      <label>Motivo</label>
      <textarea
        pInputTextarea
        [ngModel]="motivoCancelacion()"
        (ngModelChange)="motivoCancelacion.set($event)"
        rows="4"
        placeholder="Ingresa el motivo de cancelación"
      >
      </textarea>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      [outlined]="true"
      (click)="mostrarDialogCancelacion.set(false)"
    >
    </p-button>
    <app-async-button
      label="Confirmar"
      icon="pi pi-check"
      [action]="cancelarReservas"
      styleClass="p-button-danger"
    >
    </app-async-button>
  </ng-template>
</p-dialog>

<p-dialog
  header="Editar Horario"
  [visible]="mostrarDialogEditar()"
  (visibleChange)="mostrarDialogEditar.set($event)"
  [modal]="true"
  [style]="{ width: '450px' }"
>
  <div class="p-fluid">
    @if (horarioEditando()) {
    <div class="grid">
      <div class="col-12 md:col-6">
        <div class="field">
          <label>Hora inicio</label>
          <p-dropdown
            [options]="horas"
            [ngModel]="horarioEditHoraInicio()"
            (ngModelChange)="horarioEditHoraInicio.set($event)"
            optionLabel="label"
            optionValue="value"
            [style]="{ width: '100%' }"
          >
          </p-dropdown>
        </div>
      </div>
      <div class="col-12 md:col-6">
        <div class="field">
          <label>Hora fin</label>
          <p-dropdown
            [options]="horas"
            [ngModel]="horarioEditHoraFin()"
            (ngModelChange)="horarioEditHoraFin.set($event)"
            optionLabel="label"
            optionValue="value"
            [style]="{ width: '100%' }"
          >
          </p-dropdown>
        </div>
      </div>
    </div>

    <div class="field">
      <label>Capacidad</label>
      <p-inputNumber
        [ngModel]="horarioEditCapacidad()"
        (ngModelChange)="horarioEditCapacidad.set($event)"
        [min]="capacidadMinimaHorarioEditando()"
        [max]="100"
        [showButtons]="true"
        [style]="{ width: '100%' }"
      >
      </p-inputNumber>
      @if (reservasActivasHorarioEditando() > 0) {
      <small class="text-color-secondary mt-1 block">
        <i class="pi pi-info-circle mr-1"></i>
        Este horario tiene
        <strong>{{ reservasActivasHorarioEditando() }}</strong> reserva(s)
        activa(s) (pendientes o confirmadas). La capacidad mínima permitida es
        <strong>{{ reservasActivasHorarioEditando() }}</strong
        >. Las reservas completadas o ausentes no cuentan hacia la capacidad.
      </small>
      }
    </div>

    <div class="field">
      <label>Descripción (opcional)</label>
      <textarea
        pInputTextarea
        [ngModel]="horarioEditDescripcion()"
        (ngModelChange)="horarioEditDescripcion.set($event)"
        [rows]="3"
        [autoResize]="true"
        placeholder="Añade una descripción para este horario..."
      >
      </textarea>
    </div>
    }
  </div>
  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        [outlined]="true"
        (click)="mostrarDialogEditar.set(false)"
      >
      </p-button>
      <app-async-button
        label="Guardar"
        icon="pi pi-check"
        [action]="guardarHorarioEditado"
        styleClass="p-button-primary"
      >
      </app-async-button>
    </div>
  </ng-template>
</p-dialog>

<p-confirmDialog></p-confirmDialog>
