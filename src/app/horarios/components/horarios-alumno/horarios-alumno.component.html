<div class="horarios-alumno-container">

  <div class="grid">
    <div class="col-12 lg:col-4">
      <div class="card calendar-card sticky-calendar">
        <app-calendario-horarios
          [diasEstados]="diasEstados()"
          [diasConReservas]="diasConReservasAlumno()"
          [modoMultiSeleccion]="false"
          [fechaExterna]="fechaSeleccionada()"
          (fechaSeleccionada)="onFechaSeleccionada($event)">
        </app-calendario-horarios>

        <div class="leyenda-compacta mt-3">
          <div class="leyenda-item">
            <span class="dot disponible"></span>
            <span>Disponible</span>
          </div>
          <div class="leyenda-item">
            <span class="dot parcial"></span>
            <span>Parcial</span>
          </div>
          <div class="leyenda-item">
            <span class="dot completo"></span>
            <span>Completo</span>
          </div>
          <div class="leyenda-item">
            <span class="dot reserva"></span>
            <span>Con reserva</span>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 lg:col-8">
      <div class="card">
        <p-tabView [activeIndex]="tabActivo()" (onChange)="onTabChange($event)">
          <p-tabPanel header="Mis Reservas">
            <div class="reservas-card-content">
              <!-- Contadores rápidos -->
              <div class="reservas-stats mb-3">
                <div class="stat-item" [class.active]="filtroEstado() === 'TODAS'" (click)="cambiarFiltroEstado('TODAS')">
                  <i class="pi pi-list"></i>
                  <div class="stat-content">
                    <span class="stat-label">Total</span>
                    <span class="stat-value">{{ contadoresReservas().todas }}</span>
                  </div>
                </div>
                <div class="stat-item" [class.active]="filtroEstado() === EstadoReserva.PENDIENTE" (click)="cambiarFiltroEstado(EstadoReserva.PENDIENTE)">
                  <i class="pi pi-clock"></i>
                  <div class="stat-content">
                    <span class="stat-label">Pendientes</span>
                    <span class="stat-value">{{ contadoresReservas().pendientes }}</span>
                  </div>
                </div>
                <div class="stat-item" [class.active]="filtroEstado() === EstadoReserva.CONFIRMADA" (click)="cambiarFiltroEstado(EstadoReserva.CONFIRMADA)">
                  <i class="pi pi-check-circle"></i>
                  <div class="stat-content">
                    <span class="stat-label">Confirmadas</span>
                    <span class="stat-value">{{ contadoresReservas().confirmadas }}</span>
                  </div>
                </div>
                <div class="stat-item" [class.active]="filtroEstado() === EstadoReserva.COMPLETADA" (click)="cambiarFiltroEstado(EstadoReserva.COMPLETADA)">
                  <i class="pi pi-check"></i>
                  <div class="stat-content">
                    <span class="stat-label">Completadas</span>
                    <span class="stat-value">{{ contadoresReservas().completadas }}</span>
                  </div>
                </div>
              </div>

              <div class="reservas-filters mb-3">
                <div class="filters-row">
                  <div class="search-filter">
                    <p-iconField iconPosition="left">
                      <p-inputIcon styleClass="pi pi-search" />
                      <input
                        type="text"
                        pInputText
                        placeholder="Buscar profesor..."
                        [ngModel]="busquedaProfesor()"
                        (ngModelChange)="busquedaProfesor.set($event)"
                        class="w-full" />
                    </p-iconField>
                  </div>

                  <p-button
                    [icon]="mostrarPasadas() ? 'pi pi-eye-slash' : 'pi pi-eye'"
                    [outlined]="!mostrarPasadas()"
                    severity="secondary"
                    size="small"
                    (click)="mostrarPasadas.set(!mostrarPasadas())"
                    pTooltip="Mostrar/ocultar pasadas">
                  </p-button>

                  @if (tieneFiltrosActivos()) {
                    <p-button
                      icon="pi pi-filter-slash"
                      [text]="true"
                      severity="secondary"
                      size="small"
                      (click)="limpiarFiltros()"
                      pTooltip="Limpiar filtros">
                    </p-button>
                  }
                </div>
              </div>

              <div class="reservas-list">
                @if(reservasParaMostrar().length > 0) {
                  @for(grupo of reservasAgrupadasParaMostrar(); track grupo.fecha) {
                    <div class="fecha-grupo">
                      <div class="fecha-header">
                        <i class="pi pi-calendar"></i>
                        <span>{{ grupo.fecha }}</span>
                        <p-chip [label]="grupo.reservas.length + ''" [style]="{fontSize: '0.75rem'}"></p-chip>
                      </div>
                      @for(reserva of grupo.reservas; track reserva.id) {
                        <div class="reserva-card" [class.reserva-pasada]="esReservaPasada(reserva)">
                          <div class="reserva-content">
                            <div class="reserva-main">
                              <div class="reserva-time">
                                <i class="pi pi-clock"></i>
                                <strong>{{ reserva.horarioDisponible?.horaInicio | date:'HH:mm' }} - {{ reserva.horarioDisponible?.horaFin | date:'HH:mm' }}</strong>
                              </div>
                              <div class="reserva-profesor">
                                <i class="pi pi-user"></i>
                                {{ reserva.horarioDisponible?.admin?.nombre }} {{ reserva.horarioDisponible?.admin?.apellidos }}
                              </div>
                              @if (reserva.estado === EstadoReserva.CANCELADA && reserva.canceladoPor) {
                                <div class="reserva-cancelado-por">
                                  <i class="pi pi-user-minus"></i>
                                  <span><strong>Cancelado por:</strong> {{ reserva.canceladoPor.nombre }} {{ reserva.canceladoPor.apellidos }}</span>
                                </div>
                              }
                              @if (reserva.motivoCancelacion) {
                                <div class="reserva-motivo">
                                  <i class="pi pi-info-circle"></i>
                                  <span>{{ reserva.motivoCancelacion }}</span>
                                </div>
                              }
                            </div>
                            <div class="reserva-side">
                              <p-tag
                                [value]="getEstadoLabel(reserva.estado)"
                                [severity]="getEstadoSeverity(reserva.estado)"
                                [style]="{fontSize: '0.75rem'}">
                              </p-tag>
                              @if (puedeCancelarReserva(reserva)) {
                                <p-button
                                  icon="pi pi-times"
                                  severity="danger"
                                  [text]="true"
                                  size="small"
                                  [rounded]="true"
                                  (click)="abrirDialogCancelacion(reserva.id)"
                                  pTooltip="Cancelar reserva">
                                </p-button>
                              }
                            </div>
                          </div>
                        </div>
                      }
                    </div>
                  }
                } @else {
                  <div class="sin-reservas">
                    <i class="pi pi-inbox text-5xl mb-3 block text-color-secondary"></i>
                    <p class="text-muted">
                      @if (tieneFiltrosActivos()) {
                        No hay reservas que coincidan con los filtros
                      } @else {
                        No hay reservas
                      }
                    </p>
                  </div>
                }
              </div>
            </div>
          </p-tabPanel>

          <p-tabPanel header="Tutorías disponibles">
            <div class="horarios-content">
              @if (!fechaSeleccionada()) {
                <div class="no-fecha-seleccionada-placeholder">
                  <i class="pi pi-calendar-plus text-6xl mb-3 block text-color-secondary"></i>
                  <h3 class="m-0 mb-2">Selecciona un día en el calendario</h3>
                  <p class="text-color-secondary m-0">Elige una fecha para ver las tutorías disponibles</p>
                </div>
              } @else {
                <div class="flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
                  <h3 class="m-0">
                    {{ fechaSeleccionada() | date:'d MMM yyyy':'':'es-ES' }}
                  </h3>
                  <p-chip
                    [label]="totalHorariosDisponibles() + ' tutorias'"
                    icon="pi pi-clock">
                  </p-chip>
                </div>

                @if (horariosPorProfesor().length > 0) {
                  <!-- Vista Desktop: Tabla -->
                  <div class="horarios-grid desktop-view">
                    <table class="horarios-rejilla">
                      <thead>
                        <tr>
                          @for (item of horariosPorProfesor(); track item.profesor.id) {
                            <th class="col-profesor">
                              <div class="profesor-header">
                                <div class="profesor-avatar">
                                  @if (getAvatarUrl(item.profesor)) {
                                    <p-avatar [image]="getAvatarUrl(item.profesor)!" shape="circle" size="normal"></p-avatar>
                                  } @else {
                                    <p-avatar [label]="getAvatarLabel(item.profesor)" shape="circle" size="normal"></p-avatar>
                                  }
                                </div>
                                <div class="profesor-nombre">{{ item.profesor.nombre }} {{ item.profesor.apellidos }}</div>
                                <div class="profesor-email">{{ item.profesor.email }}</div>
                              </div>
                            </th>
                          }
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          @for (item of horariosPorProfesor(); track item.profesor.id) {
                            <td class="col-profesor-horarios">
                              <div class="horarios-list">
                                @if (item.horarios.length > 0) {
                                  @for (horario of item.horarios; track horario.id) {
                                    <div class="horario-item" [class.horario-reservado]="tieneReservaActiva(horario.id)">
                                      <p-checkbox
                                        [inputId]="'horario-' + horario.id + '-' + item.profesor.id"
                                        [binary]="true"
                                        [ngModel]="isHorarioSeleccionado(horario.id) || tieneReservaActiva(horario.id)"
                                        (onChange)="toggleHorarioSeleccionado(horario.id)"
                                        [disabled]="getDisponibles(horario) === 0 || tieneReservaActiva(horario.id)">
                                      </p-checkbox>
                                      <label [for]="'horario-' + horario.id + '-' + item.profesor.id" class="horario-label">
                                        <span class="horario-time">{{ getHorarioLabel(horario) }}</span>
                                        @if (tieneReservaActiva(horario.id)) {
                                          <span class="badge-reservado">(Ya reservado)</span>
                                        } @else if (getDisponibles(horario) > 0) {
                                          <span class="badge-disponible">({{ getDisponibles(horario) }} disponible{{ getDisponibles(horario) > 1 ? 's' : '' }})</span>
                                        } @else {
                                          <span class="badge-completo">(Completo)</span>
                                        }
                                      </label>
                                    </div>
                                  }
                                } @else {
                                  <div class="sin-horarios">
                                    <p class="text-muted">No hay horarios disponibles</p>
                                  </div>
                                }
                              </div>
                            </td>
                          }
                        </tr>
                      </tbody>
                    </table>
                  </div>

                  <!-- Vista Móvil: Acordeón -->
                  <div class="horarios-accordion mobile-view">
                    <p-accordion [multiple]="true">
                      @for (item of horariosPorProfesor(); track item.profesor.id) {
                        <p-accordionTab>
                          <ng-template pTemplate="header">
                            <div class="accordion-header">
                              <div class="profesor-info">
                                <div class="profesor-avatar">
                                  @if (getAvatarUrl(item.profesor)) {
                                    <p-avatar [image]="getAvatarUrl(item.profesor)!" shape="circle" size="normal"></p-avatar>
                                  } @else {
                                    <p-avatar [label]="getAvatarLabel(item.profesor)" shape="circle" size="normal"></p-avatar>
                                  }
                                </div>
                                <div class="profesor-details">
                                  <div class="profesor-nombre">{{ item.profesor.nombre }} {{ item.profesor.apellidos }}</div>
                                  <div class="profesor-email">{{ item.profesor.email }}</div>
                                </div>
                              </div>
                              <span class="horarios-count">{{ item.horarios.length }} horario{{ item.horarios.length !== 1 ? 's' : '' }}</span>
                            </div>
                          </ng-template>
                          <div class="horarios-list">
                            @if (item.horarios.length > 0) {
                              @for (horario of item.horarios; track horario.id) {
                                <div class="horario-item" [class.horario-reservado]="tieneReservaActiva(horario.id)">
                                  <p-checkbox
                                    [inputId]="'horario-mobile-' + horario.id + '-' + item.profesor.id"
                                    [binary]="true"
                                    [ngModel]="isHorarioSeleccionado(horario.id) || tieneReservaActiva(horario.id)"
                                    (onChange)="toggleHorarioSeleccionado(horario.id)"
                                    [disabled]="getDisponibles(horario) === 0 || tieneReservaActiva(horario.id)">
                                  </p-checkbox>
                                  <label [for]="'horario-mobile-' + horario.id + '-' + item.profesor.id" class="horario-label">
                                    <span class="horario-time">{{ getHorarioLabel(horario) }}</span>
                                    @if (tieneReservaActiva(horario.id)) {
                                      <span class="badge-reservado">(Ya reservado)</span>
                                    } @else if (getDisponibles(horario) > 0) {
                                      <span class="badge-disponible">({{ getDisponibles(horario) }} disponible{{ getDisponibles(horario) > 1 ? 's' : '' }})</span>
                                    } @else {
                                      <span class="badge-completo">(Completo)</span>
                                    }
                                  </label>
                                </div>
                              }
                            } @else {
                              <div class="sin-horarios">
                                <p class="text-muted">No hay horarios disponibles</p>
                              </div>
                            }
                          </div>
                        </p-accordionTab>
                      }
                    </p-accordion>
                  </div>

                  <div class="mt-3">
                    <app-async-button
                      label="Reservar horarios seleccionados"
                      icon="pi pi-check"
                      [action]="abrirDialogNotas"
                      [disabled]="horariosSeleccionados.length === 0"
                      styleClass="p-button-primary">
                    </app-async-button>
                  </div>
                } @else {
                  <div class="no-horarios-disponibles">
                    <i class="pi pi-calendar-times text-6xl mb-3 block text-color-secondary"></i>
                    <h3 class="m-0 mb-2">No hay horarios disponibles</h3>
                    <p class="text-color-secondary m-0">No hay horarios disponibles para el día seleccionado.</p>
                  </div>
                }
              }
            </div>
          </p-tabPanel>
        </p-tabView>
      </div>
    </div>
  </div>
</div>

<p-dialog
  header="Cancelar Reserva"
  [visible]="mostrarDialogCancelacion()"
  (visibleChange)="mostrarDialogCancelacion.set($event)"
  [modal]="true"
  [style]="{width: '450px'}">
  <div class="p-fluid">
    <div class="field">
      <label>Motivo de cancelación</label>
      <textarea
        pInputTextarea
        [ngModel]="motivoCancelacion()"
        (ngModelChange)="motivoCancelacion.set($event)"
        rows="4"
        placeholder="Ingresa el motivo de cancelación">
      </textarea>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      [outlined]="true"
      (click)="mostrarDialogCancelacion.set(false)">
    </p-button>
    <app-async-button
      label="Confirmar"
      icon="pi pi-check"
      [action]="cancelarReserva"
      styleClass="p-button-danger">
    </app-async-button>
  </ng-template>
</p-dialog>

<p-dialog
  header="Añadir Notas a la Reserva"
  [visible]="mostrarDialogNotas()"
  (visibleChange)="mostrarDialogNotas.set($event)"
  [modal]="true"
  [style]="{width: '450px'}">
  <div class="p-fluid">
    <div class="field">
      <label>Notas (opcional)</label>
      <textarea
        pInputTextarea
        [ngModel]="notasReserva()"
        (ngModelChange)="notasReserva.set($event)"
        rows="4"
        placeholder="Añade notas adicionales para esta reserva...">
      </textarea>
      <small class="text-color-secondary">Puedes dejar este campo vacío si no deseas añadir notas</small>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <p-button
      label="Cancelar"
      icon="pi pi-times"
      [outlined]="true"
      (click)="mostrarDialogNotas.set(false)">
    </p-button>
    <app-async-button
      label="Confirmar Reserva"
      icon="pi pi-check"
      [action]="crearReserva"
      styleClass="p-button-primary">
    </app-async-button>
  </ng-template>
</p-dialog>
