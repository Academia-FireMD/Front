<div class="resultado-simulacro-container">
  <div class="loading-container" *ngIf="loading">
    <p-progressSpinner></p-progressSpinner>
    <p>Cargando resultados del simulacro...</p>
  </div>

  <div class="error-container" *ngIf="error">
    <p-card>
      <div class="error-message">
        <i class="pi pi-exclamation-triangle"></i>
        <h3>No se pudieron cargar los resultados</h3>
        <p>{{ errorMessage || 'Ha ocurrido un error al intentar cargar los resultados del simulacro.' }}</p>
        <button pButton label="Volver" icon="pi pi-arrow-left" (click)="volver()"></button>
      </div>
    </p-card>
  </div>

  <div *ngIf="!loading && !error" class="resultados-content">
    <div class="header mb-4">
      <h1 class="text-center text-2xl font-bold text-primary mb-4">{{ examen?.titulo }}</h1>
      <p class="text-center text-sm text-500 mb-4">{{ examen?.fechaActivacion | date:'dd \'de\' MMMM, yyyy':'es' }}</p>

      <!-- Mi Resultado Principal -->
      <div *ngIf="miResultado" class="mi-resultado-section">
        <!-- Posición Badge -->
        <div class="posicion-banner text-center mb-4" *ngIf="miPosicion">
          <div class="posicion-badge inline-flex align-items-center bg-yellow-100 text-yellow-800 px-4 py-2 border-round-lg">
            <i class="pi pi-trophy mr-2"></i>
            <span class="font-semibold">Tu posición: {{ miPosicion }}° de {{ totalParticipantes }} participantes</span>
          </div>
        </div>

        <!-- Grid de Estadísticas -->
        <div class="grid">
          <!-- Nota con Gráfico Circular -->
          <div class="col-12 md:col-4">
            <app-score-chart-card
              title="Nota Final"
              [score]="miResultado.estadisticas.nota"
              description="Puntuación obtenida"
            ></app-score-chart-card>
          </div>

          <!-- Estadísticas KPI -->
          <div class="col-12 md:col-8">
            <app-kpi-stats-cards
              [stats]="getKpiStatsForResult(miResultado.estadisticas)"
            ></app-kpi-stats-cards>
          </div>
        </div>

        <!-- Botón Ver Respuestas -->
        <div class="text-center mt-4">
          <button
            pButton
            type="button"
            label="Ver respuestas"
            icon="pi pi-eye"
            class="p-button-outlined p-button-primary"
            (click)="verRespuestas(miResultado.testId)"
          ></button>
        </div>

        <!-- Cards de Combinaciones de Confianza (Mi resultado) -->
        <div class="col-12 mb-4 mt-4" *ngIf="miResultado?.estadisticas?.detalles?.seguridad">
          <app-confidence-analysis-cards
            [analyses]="getCombinedConfidenceAnalysisFromSecurity(miResultado.estadisticas.detalles.seguridad, miResultado.estadisticas.totalPreguntas)"
            [cardCol]="'col-12 md:col-4'"
          ></app-confidence-analysis-cards>
        </div>

        <!-- Desplegable análisis individual (Mi resultado) -->
        <div class="col-12">
          <div
            class="flex align-items-center mb-3 cursor-pointer justify-content-between"
            (click)="showIndividualConfidenceMi = !showIndividualConfidenceMi"
          >
            <h3 class="text-xl font-semibold text-700 mr-2">Análisis por Nivel de Confianza</h3>
            <i class="pi" [class.pi-chevron-down]="!showIndividualConfidenceMi" [class.pi-chevron-up]="showIndividualConfidenceMi"></i>
          </div>
          <div *ngIf="showIndividualConfidenceMi">
            <app-confidence-analysis-cards
              *ngIf="miResultado?.estadisticas?.detalles?.seguridad"
              [analyses]="getConfidenceAnalysisForResult(miResultado.estadisticas.detalles.seguridad)"
            ></app-confidence-analysis-cards>
          </div>
        </div>
      </div>

      <!-- Último intento (no registrado) -->
      <div *ngIf="ultimoIntento" class="ultimo-intento-section mt-4">
        <h3 class="text-lg font-semibold text-700 mb-3">Último Intento (no cuenta para el ranking)</h3>
        <div class="grid">
          <div class="col-12 md:col-4">
            <app-score-chart-card
              title="Nota Último Intento"
              [score]="ultimoIntento.estadisticas.nota"
              description="Puntuación obtenida"
            ></app-score-chart-card>
          </div>
          <div class="col-12 md:col-8">
            <app-kpi-stats-cards
              [stats]="getKpiStatsForResult(ultimoIntento.estadisticas)"
            ></app-kpi-stats-cards>
          </div>
        </div>
        <div class="text-center mt-3">
          <button
            pButton
            type="button"
            label="Ver respuestas"
            icon="pi pi-eye"
            class="p-button-outlined p-button-primary"
            (click)="verRespuestas(ultimoIntento.testId)"
          ></button>
        </div>

        <!-- Cards de Combinaciones de Confianza (Último intento) -->
        <div class="col-12 mb-4 mt-4" *ngIf="ultimoIntento?.estadisticas?.detalles?.seguridad">
          <app-confidence-analysis-cards
            [analyses]="getCombinedConfidenceAnalysisFromSecurity(ultimoIntento.estadisticas.detalles.seguridad, ultimoIntento.estadisticas.totalPreguntas)"
            [cardCol]="'col-12 md:col-4'"
          ></app-confidence-analysis-cards>
        </div>

        <!-- Desplegable análisis individual (Último intento) -->
        <div class="col-12">
          <div
            class="flex align-items-center mb-3 cursor-pointer justify-content-between"
            (click)="showIndividualConfidenceUltimo = !showIndividualConfidenceUltimo"
          >
            <h3 class="text-xl font-semibold text-700 mr-2">Análisis por Nivel de Confianza</h3>
            <i class="pi" [class.pi-chevron-down]="!showIndividualConfidenceUltimo" [class.pi-chevron-up]="showIndividualConfidenceUltimo"></i>
          </div>
          <div *ngIf="showIndividualConfidenceUltimo">
            <app-confidence-analysis-cards
              *ngIf="ultimoIntento?.estadisticas?.detalles?.seguridad"
              [analyses]="getConfidenceAnalysisForResult(ultimoIntento.estadisticas.detalles.seguridad)"
            ></app-confidence-analysis-cards>
          </div>
        </div>
      </div>
    </div>

    <p-divider></p-divider>

    <div class="leaderboard-container">
      <h3>Clasificación</h3>

      <p-table
        [value]="resultados"
        [paginator]="resultados.length > 10"
        [rows]="10"
        [rowHover]="true"
        styleClass="p-datatable-sm p-datatable-striped"
        [scrollable]="true"
        dataKey="usuario.id"
        [expandedRowKeys]="expandedRowKeys"
      >
        <ng-template pTemplate="header">
          <tr>
            <th style="width: 80px">Posición</th>
            <th>Participante</th>
            <th style="width: 100px">Nota</th>
            <th style="width: 120px">Correctas</th>
            <th style="width: 120px">Incorrectas</th>
            <th style="width: 150px">Fecha</th>
            <th style="width: 60px">Detalles</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-resultado let-i="rowIndex" let-expanded="expanded">
          <tr [ngClass]="{'mi-resultado': resultado.usuario.esTuResultado}">
            <td>
              <div class="posicion-badge" [ngClass]="getColorClass(resultado.posicion)">
                {{ resultado.posicion }}
              </div>
            </td>
            <td>
              <div class="usuario-info">
                <span class="usuario-nombre">
                  {{ resultado.usuario.nombre }}
                  {{ resultado.usuario.apellidos ? resultado.usuario.apellidos : '' }}
                </span>
                <span *ngIf="resultado.usuario.esAcademia" class="academia-badge">Academia</span>
                <span *ngIf="resultado.usuario.esTuResultado" class="tu-badge">Tú</span>
              </div>
              <div class="usuario-email" *ngIf="isAdmin && resultado.usuario.email">
                {{ resultado.usuario.email }}
              </div>
            </td>
            <td>
              <div class="nota-valor" [ngClass]="getNotaClass(resultado.estadisticas.nota)">
                {{ resultado.estadisticas.nota !== null ? resultado.estadisticas.nota.toFixed(2) : 'N/A' }}
              </div>
            </td>
            <td>
              <div class="correctas-valor">
                {{ resultado.estadisticas.correctas }}
                <span class="porcentaje">
                  ({{ resultado.estadisticas.totalPreguntas ?
                        (resultado.estadisticas.correctas / resultado.estadisticas.totalPreguntas * 100).toFixed(0) : 0 }}%)
                </span>
              </div>
            </td>
            <td>
              <div class="incorrectas-valor">
                {{ resultado.estadisticas.incorrectas }}
                <span class="porcentaje">
                  ({{ resultado.estadisticas.totalPreguntas ?
                        (resultado.estadisticas.incorrectas / resultado.estadisticas.totalPreguntas * 100).toFixed(0) : 0 }}%)
                </span>
              </div>
            </td>
            <td>
              {{ resultado.fechaRealizacion | date:'dd/MM/yyyy HH:mm' }}
            </td>
            <td>
              <p-button
                icon="pi pi-chevron-down"
                class="p-button-text p-button-sm"
                [style]="{'transform': expandedRowKeys[resultado.usuario.id] ? 'rotate(180deg)' : 'rotate(0deg)', 'transition': 'transform 0.3s'}"
                pTooltip="Ver análisis por confianza"
                (click)="toggleRowExpansion(resultado)"
              ></p-button>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-resultado>
          <tr>
            <td colspan="8">
              <div class="p-3">
                <h5 class="mb-3">Análisis por Nivel de Confianza</h5>
                <!-- Cards combinadas -->
                <app-confidence-analysis-cards
                  *ngIf="resultado.estadisticas?.detalles?.seguridad"
                  [analyses]="getCombinedConfidenceAnalysisFromSecurity(resultado.estadisticas.detalles.seguridad, resultado.estadisticas.totalPreguntas)"
                  [cardCol]="'col-12 md:col-4'"
                ></app-confidence-analysis-cards>

                <!-- Desplegable con análisis individual -->
                <div class="flex align-items-center mb-3 cursor-pointer justify-content-between" *ngIf="resultado.estadisticas?.detalles?.seguridad" (click)="showIndividualConfidenceByUserId[resultado.usuario.id] = !showIndividualConfidenceByUserId[resultado.usuario.id]">
                  <h6 class="text-lg font-semibold text-700 mr-2">Detalle por nivel</h6>
                  <i class="pi" [class.pi-chevron-down]="!showIndividualConfidenceByUserId[resultado.usuario.id]" [class.pi-chevron-up]="showIndividualConfidenceByUserId[resultado.usuario.id]"></i>
                </div>
                <div *ngIf="resultado.estadisticas?.detalles?.seguridad && showIndividualConfidenceByUserId[resultado.usuario.id]">
                  <app-confidence-analysis-cards
                    [analyses]="getConfidenceAnalysisForResult(resultado.estadisticas.detalles.seguridad)"
                    [attr.data-row-id]="resultado.usuario.id"
                  ></app-confidence-analysis-cards>
                </div>

                <div *ngIf="!resultado.estadisticas?.detalles?.seguridad" class="text-center p-4">
                  <p class="text-muted">No hay datos de confianza disponibles para este resultado</p>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="8" class="text-center">
              No hay resultados disponibles para este simulacro.
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>

    <div class="actions" *ngIf="!ocultarVolver">
      <button pButton label="Volver" icon="pi pi-arrow-left" class="p-button-outlined" (click)="volver()"></button>
    </div>
  </div>
</div>
