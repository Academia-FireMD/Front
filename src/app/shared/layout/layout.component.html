<div class="grid h-full" style="overflow: hidden">
  <div class="bar w-full mb-2" *ngIf="viewportService.screenWidth === 'xs'">
    <button
      class="p-button p-button-text p-button-icon-only"
      (click)="toggleMenu()"
    >
      <i class="pi pi-bars"></i>
    </button>
  </div>

  <div
    class="col-auto py-0 pl-0 lateral-bar"
    [ngClass]="{
      'mobile-expanded': viewportService.screenWidth == 'xs' && isMenuVisible,
      'menu-collapsed': !isMenuExpanded && viewportService.screenWidth !== 'xs',
      'menu-expanded': isMenuExpanded && viewportService.screenWidth !== 'xs'
    }"
    *ngIf="viewportService.screenWidth !== 'xs' || isMenuVisible"
    (mouseenter)="onMenuHover(true)"
    (mouseleave)="onMenuHover(false)"
  >
    <p-menu
      [model]="items"
      styleClass="w-full h-full overflow-x-hidden"
      *ngIf="authService.currentUser$ | async as user"
    >
      <ng-template pTemplate="start">
        <div class="image-container py-3">
          <img
            src="white_logo.png"
            alt="Logo"
            [class.small-logo]="
              !isMenuExpanded && viewportService.screenWidth !== 'xs'
            "
          />
        </div>

        <!-- Banner de impersonaci贸n -->
        <div
          *ngIf="authService.isImpersonating()"
          class="impersonation-banner p-2 mb-2 mx-2 border-round"
          [ngClass]="{
            'impersonation-banner-collapsed':
              !isMenuExpanded && viewportService.screenWidth !== 'xs',
            'impersonation-banner-expanded':
              isMenuExpanded || viewportService.screenWidth === 'xs'
          }"
        >
          <div class="flex align-items-center gap-2">
            <i
              class="pi pi-user-edit text-orange-500"
              *ngIf="isMenuExpanded || viewportService.screenWidth === 'xs'"
            ></i>
            <div
              class="flex-1"
              *ngIf="isMenuExpanded || viewportService.screenWidth === 'xs'"
            >
              <div class="text-xs text-orange-500 font-medium">
                Impersonando a:
              </div>
              <div class="text-sm text-orange-800 font-bold">
                {{ user.nombre + " " + user.apellidos }}
              </div>
            </div>
            <p-button
              icon="pi pi-sign-out"
              styleClass="p-button-sm p-button-text p-button-rounded"
              (click)="stopImpersonation()"
              pTooltip="Salir de impersonaci贸n"
              tooltipPosition="bottom"
            />
          </div>
        </div>

        <div
          (click)="editProfile()"
          class="perfil p-2 flex align-items-center justify-content-{{
            isMenuExpanded ? 'start' : 'center'
          }} w-full gap-2 pointer"
        >
          <div class="avatar-container mt-0">
            @if (!user.avatarUrl) {
            <i class="pi pi-user"></i>
            } @else {
            <img
              [src]="user.avatarUrl"
              alt="Avatar"
              class="avatar-preview"
              style="max-width: 32px; max-height: 32px"
            />
            }
          </div>

          <span
            class="descripcion"
            *ngIf="isMenuExpanded || viewportService.screenWidth === 'xs'"
          >
            {{ user.nombre + " " + user.apellidos }}
          </span>
        </div>
      </ng-template>
      <ng-template pTemplate="submenuheader" let-item>
        <div
          class="menu-header gap-2"
          [class.locked-menu-item]="item.state?.locked"
          [pTooltip]="
            item.state?.locked ? 'Mejora tu suscripci贸n para acceder' : ''
          "
          tooltipPosition="right"
          [tooltipStyleClass]="item.state?.locked ? 'locked-tooltip' : ''"
          (click)="
            item.state?.locked
              ? openUpgradePage()
              : !!item.items && item.items.length > 0
              ? toggleCollapse(item)
              : navigateToPath(item.routerLink)
          "
        >
          <span
            *ngIf="item.icon"
            class="{{ item.icon + ' ' + (isMenuExpanded ? 'mr-2' : '') }}"
          ></span>
          <span
            class="font-bold"
            *ngIf="isMenuExpanded || viewportService.screenWidth === 'xs'"
            >{{ item.label }}</span
          >
          <span
            class="font-bold menu-collapsed-text"
            *ngIf="
              !isMenuExpanded &&
              viewportService.screenWidth !== 'xs' &&
              !item.icon
            "
            >{{ item.label[0] }}</span
          >
          <i
            class="pi pi-lock ml-auto locked-icon"
            *ngIf="
              item.state?.locked &&
              (isMenuExpanded || viewportService.screenWidth === 'xs')
            "
          ></i>
          <i
            *ngIf="
              !!item.items &&
              item.items.length > 0 &&
              !item.state?.locked &&
              (isMenuExpanded || viewportService.screenWidth === 'xs')
            "
            class="pi ml-auto"
            [ngClass]="item.collapsed ? 'pi-angle-down' : 'pi-angle-up'"
          ></i>
        </div>
      </ng-template>
      <ng-template pTemplate="item" let-item>
        <div *ngIf="!!item && !isParentCollapsed(item)">
          <a
            pRipple
            class="flex align-items-center p-menuitem-link"
            [class.locked-menu-item]="item.state?.locked"
            [routerLink]="!item.state?.locked ? item.routerLink : null"
            [queryParams]="item.queryParams"
            routerLinkActive="router-link-active"
            [routerLinkActiveOptions]="{ exact: true }"
            (click)="handleMenuItemClick($event, item)"
            [pTooltip]="
              item.state?.locked ? 'Mejora tu suscripci贸n para acceder' : ''
            "
            tooltipPosition="right"
            [tooltipStyleClass]="item.state?.locked ? 'locked-tooltip' : ''"
          >
            <span [class]="item.icon"></span>
            <span
              class="ml-2"
              *ngIf="isMenuExpanded || viewportService.screenWidth === 'xs'"
              >{{ item.label }}</span
            >
            <i
              class="pi pi-lock ml-auto locked-icon"
              *ngIf="
                item.state?.locked &&
                (isMenuExpanded || viewportService.screenWidth === 'xs')
              "
            ></i>
          </a>
        </div>
      </ng-template>
    </p-menu>
  </div>

  <div
    class="layout-content"
    [style.width]="getResponsiveWidth(isMenuExpanded)"
  >
    <router-outlet></router-outlet>
  </div>
</div>
