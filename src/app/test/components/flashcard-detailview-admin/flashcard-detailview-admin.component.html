<p-confirmDialog></p-confirmDialog>

<div class="grid p-2" [formGroup]="formGroup">
  <div class="col-12 content">
    <p-card>
      <p-tabView>
        <p-tabPanel header="Detalles">
          <div class="grid">
        <div
          class="col-12 header flex justify-content-between align-items-center gap-3"
        >
          <div class="identificador">
            @if(mode == 'edit'){ @if (getId() !== 'new') {
            <div class="flex align-items-center justify-content-between gap-2">
              <span *ngIf="viewportService.screenWidth != 'xs'"
                >Identificador:</span
              >
              <strong>{{ formGroup.value.identificador }}</strong>
            </div>
            }@else {
            <p-floatLabel *ngIf="expectedRole == 'ADMIN'">
              <input
                type="text"
                pInputText
                class="w-full"
                formControlName="identificador"
              />
              <label for="identificador">Identificador</label>
            </p-floatLabel>
            }}
          </div>
          <div class="actions">
            <p-button
              *ngIf="mode == 'edit'"
              [link]="true"
              icon="pi pi-angle-double-left"
              (click)="anteriorForwardFlashcard()"
            />

            <p-button
              *ngIf="mode == 'edit'"
              [link]="true"
              icon="pi pi-angle-left"
              (click)="anteriorFlashcard()"
            />

            <p-divider
              *ngIf="viewportService.screenWidth != 'xs'"
              layout="vertical"
            />

            <p-button
              *ngIf="mode == 'edit'"
              [link]="true"
              icon="pi pi-angle-right"
              (click)="siguienteFlashcard()"
            />

            <p-button
              *ngIf="mode == 'edit'"
              [link]="true"
              icon="pi pi-angle-double-right"
              (click)="siguienteForwardFlashcard()"
            />
          </div>
          <div class="relevancia">
            <app-comunidad-picker
              [allowAdd]="true"
              [comunidades]="relevancia.value"
              (updateSelection)="updateCommunitySelection($event)"
            ></app-comunidad-picker>
          </div>
        </div>

        <div class="col-6">
          <app-tema-select
            [multiple]="false"
            [formControl]="formGroup.controls['temaId']"
          ></app-tema-select>
        </div>
        <div class="col-6">
          <app-dificultad-dropdown
            [formControlDificultad]="formGroup.get('dificultad')"
            [isFlashcards]="true"
          ></app-dificultad-dropdown>
        </div>
        <div class="col-12 py-3">
          <div class="markdown-container">
            <div class="editor">
              <h3>Enunciado</h3>
              <div id="editor-enunciado"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 px-0 pt-3">
        <div class="markdown-container">
          <div class="editor">
            <h3>Solución</h3>
            <div id="editor"></div>
          </div>
        </div>
          </div>
          <div class="col-12 justify-content-end align-items-center w-full flex">
            @if (getId() == 'new' && mode == 'edit') {
            <p-checkbox
              inputId="crearOtra"
              [formControl]="crearOtroControl"
              [binary]="true"
            ></p-checkbox>
            <label for="crearOtra" class="ml-2">Crear otra</label>
            }
          </div>
          <div class="col-12 footer flex justify-content-end w-full">
            <p-button
              *ngIf="mode != 'injected'"
              label="Volver atrás"
              [link]="true"
              (click)="handleBackButton()"
            ></p-button>
            @if(getId() == 'new' || mode == 'injected'){
            <app-async-button
              label="Crear Flashcard"
              [action]="crearFlashcard.bind(this)"
            ></app-async-button>
            }@else{
            <app-async-button
              label="Actualizar Flashcard"
              [action]="actualizarFlashcard.bind(this)"
            ></app-async-button>
            }
          </div>
        </p-tabPanel>

        <p-tabPanel header="Fallos Reportados" *ngIf="expectedRole == 'ADMIN' && getId() !== 'new'">
          <div *ngIf="lastLoadedFlashcard()?.ReporteFallo && lastLoadedFlashcard().ReporteFallo.length > 0; else noFallos">
            <div *ngFor="let fallo of lastLoadedFlashcard().ReporteFallo" class="p-3 border-bottom-1 border-200">
              <div class="flex justify-content-between align-items-start">
                <div class="flex-1">
                  <div class="mb-2">
                    <strong>{{ fallo.usuario?.nombre }} {{ fallo.usuario?.apellidos }}</strong>
                    <span class="ml-2 text-sm text-500">({{ fallo.usuario?.email }})</span>
                  </div>
                  <p class="m-0 text-sm">{{ fallo.descripcion }}</p>
                  <small class="text-xs text-400">{{ fallo.createdAt | date : 'dd/MM/yyyy HH:mm' }}</small>
                </div>
                <p-button
                  icon="pi pi-check"
                  styleClass="p-button-success p-button-sm"
                  pTooltip="Marcar como solucionado"
                  (click)="eliminarFallo(fallo.id, $event)"
                ></p-button>
              </div>
            </div>
          </div>
          <ng-template #noFallos>
            <div class="text-center p-4">
              No hay fallos reportados para esta flashcard.
            </div>
          </ng-template>
        </p-tabPanel>
      </p-tabView>
    </p-card>
  </div>
</div>
