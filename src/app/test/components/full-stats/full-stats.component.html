<ng-template #notaMediaTests let-tests="tests">
  <div
    class="flex justify-content-between"
    *ngIf="calcularMediaCategoria(tests) as mediaBloque"
  >
    <div class="left flex-column">
      <div>
        Preguntas bien respondidas:
        {{ mediaBloque?.blockStats?.correctas ?? 0 }}
      </div>
      <div>Incorrectas: {{ mediaBloque?.blockStats?.incorrectas ?? 0 }}</div>
      <div>Sin contestar: {{ mediaBloque?.blockStats?.omitidas ?? 0 }}</div>
    </div>
    <div class="right flex-column">
      <div>
        Nota media ‚≠ê =
        <strong> {{ (mediaBloque?.total100 ?? 0).toFixed(2) }}</strong>
      </div>
      <div>
        Nota media üëç =
        <strong> {{ (mediaBloque?.total75 ?? 0).toFixed(2) }}</strong>
      </div>
      <div>
        Nota media üëé =
        <strong> {{ (mediaBloque?.total50 ?? 0).toFixed(2) }}</strong>
      </div>
    </div>
  </div>
</ng-template>

<div class="flex-column" *ngIf="fullStats$ | async as fullStats">
  <!-- Header con per√≠odo -->
  <div class="col-12 mb-4">
    <div class="flex align-items-center justify-content-between topbar">
      <span class="text-xl font-semibold text-700">
        Estad√≠sticas {{ type === "TESTS" ? "de Tests" : "de Flashcards" }}
      </span>
      <span class="period-badge">
        {{ from | date : "dd/MM/yyyy" }} - {{ to | date : "dd/MM/yyyy" }}
      </span>
    </div>
  </div>

  <!-- Cards de Estad√≠sticas -->
  <div class="col-12 mb-4">
    <div class="grid">
      @if (type == 'TESTS') {
      <ng-container
        *ngIf="calcularMediaCategoria(obtainAllTests(fullStats)) as mediaBloque"
      >
        <!-- Nota Global -->
        <div class="col-12 md:col-3">
          <app-score-chart-card
            title="Nota Global"
            [score]="mediaBloque.total100"
            description="Puntuaci√≥n media total"
          ></app-score-chart-card>
        </div>

        <!-- Estad√≠sticas Generales -->
        <div class="col-12 md:col-9">
          <app-kpi-stats-cards
            [stats]="getKpiStatsForTests(mediaBloque)"
          ></app-kpi-stats-cards>
        </div>
      </ng-container>
      } @else {
      <ng-container
        *ngIf="getBlockFlashcardBoxes(obtainAllTests(fullStats)) as blocks"
      >
        <app-kpi-stats-cards
          [stats]="getKpiStatsForFlashcards(blocks)"
        ></app-kpi-stats-cards>
      </ng-container>
      }
    </div>
  </div>

  <!-- An√°lisis por Nivel de Confianza -->
  <div class="col-12 mb-4" *ngIf="type == 'TESTS'">
    <h3 class="text-xl font-semibold text-700 mb-3">
      An√°lisis por Nivel de Confianza
    </h3>
    <app-confidence-analysis-cards
      [analyses]="getConfidenceAnalysisForTests(obtainAllTests(fullStats))"
    ></app-confidence-analysis-cards>
  </div>


  <!-- Tests Info -->
  <div class="col-12" *ngIf="type == 'TESTS'">
    <ng-container
      *ngTemplateOutlet="
        notaMediaTests;
        context: {
          tests: obtainAllTests($any(fullStats))
        }
      "
    ></ng-container>
  </div>

  <!-- Bloques -->
  <div class="col-12">
    <div class="mb-2">
      <strong>Por bloque</strong>
    </div>
    <p-accordion>
      <p-accordionTab *ngFor="let key of keys($any(fullStats))">
        <ng-template pTemplate="header">
          <span
            class="flex align-items-center justify-content-between gap-2 w-full"
          >
            <span class="font-bold white-space-nowrap">{{
              toPascalCase(key)
            }}</span>
            @if(type == 'TESTS'){
            <div
              *ngIf="
                calcularMediaCategoria($any(fullStats[key])) as mediaBloque
              "
            >
              <span class="text-sm font-small">
                <strong>{{ mediaBloque.total100.toFixed(2) }}</strong>
                (‚≠ê)
              </span>
              <span class="text-sm font-small">
                <strong>{{ mediaBloque.total75.toFixed(2) }}</strong>
                (üëç)
              </span>
              <span class="text-sm font-small">
                <strong>{{ mediaBloque.total50.toFixed(2) }}</strong>
                (üëé)
              </span>
            </div>
            }
          </span>
        </ng-template>

        <div class="contenido">
          <div class="header">
            <div>
              <strong>Informaci√≥n del bloque</strong>
            </div>

            @if (type == 'TESTS') {
            <ng-container
              *ngTemplateOutlet="
                notaMediaTests;
                context: {
                  tests: fullStats[key]
                }
              "
            ></ng-container>
            }@else {
            <div
              class="data-box"
              *ngFor="
                let stat of getBlockFlashcardBoxes(fullStats[key]);
                let i = index
              "
            >
              <div
                class="box"
                [ngStyle]="{
                  'background-color': stat.color
                }"
              ></div>
              <span
                >{{ stat.value }} (<strong>{{
                  stat.porcentaje.toFixed(2)
                }}</strong
                >%)</span
              >
            </div>
            }
          </div>
          <div class="contenido">
            <div class="card">
                @if (type == 'TESTS') {
                <ng-container
                  *ngIf="getBlockBarData(fullStats[key]) as blockBarData"
                >

                  <div
                    echarts
                    (chartDblClick)="onChartClick($event)"
                    [options]="blockBarData.chartOption"
                    [id]="'full-stats-chart-' + key"
                    [initOpts]="{ renderer: 'canvas' }"
                    class="demo-chart"
                  ></div>
                </ng-container>
                }@else {
                <ng-container
                  *ngIf="getFlashcardBarData(fullStats[key]) as blockBarData"
                >
                  <div
                    echarts
                    (chartDblClick)="onChartClick($event)"
                    [options]="blockBarData.chartOption"
                    [id]="'full-stats-chart-' + key"
                    [initOpts]="{ renderer: 'canvas' }"
                    class="demo-chart"
                  ></div>
                </ng-container>
                }
              </div>
          </div>
        </div>
      </p-accordionTab>
    </p-accordion>
  </div>
</div>
