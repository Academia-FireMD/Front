<p-confirmDialog></p-confirmDialog>

<app-generic-list
  [fetchItems$]="fetchItems$"
  [itemTemplate]="flashcardItemTemplate"
  [filters]="filters"
  (onItemClick)="navigateToDetailview($any($event).id)"
  (filtersChanged)="onFiltersChanged($event)"
>
  <div left-actions>
    <p-iconField iconPosition="left">
      <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
      <input
        type="text"
        class="w-full"
        pInputText
        placeholder="Buscar flashcards"
        style="min-width: 30vw"
        [value]="pagination().searchTerm"
        (input)="valueChanged($event)"
      />
    </p-iconField>
  </div>

  <div right-actions>
    <div class="flex gap-2">
      <p-button
        *ngIf="expectedRole == 'ADMIN'"
        label="{{
          viewportService.screenWidth == 'xs'
            ? undefined
            : 'Descargar flashcards de alumnos'
        }}"
        icon="pi pi-download"
        [link]="true"
        (click)="descargarFlashcardsDeAlumnos()"
      ></p-button>

      <p-button
        label="{{
          viewportService.screenWidth == 'xs' ? undefined : 'Ficheros'
        }}"
        icon="pi pi-file"
        [link]="true"
        (click)="abrirDialogoFicheros()"
      ></p-button>
      <p-button
      label="{{
        viewportService.screenWidth == 'xs' ? undefined : 'Crear nueva'
      }}"
      icon="pi pi-plus"
      (click)="navigateToDetailview('new')"
    ></p-button>
    </div>
  </div>

  <div empty-template>
    <div class="text-center p-4">No hay flashcards disponibles</div>
  </div>
</app-generic-list>

<p-dialog
  header="Gestión de ficheros"
  [(visible)]="mostrarFicherosDialog"
  [modal]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '50vw' }"
  [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
>
  <!-- Toggle para elegir modo -->
  <div class="flex justify-content-center mb-4">
    <p-selectButton
      [options]="[
        { label: 'Importar', value: 'importar', icon: 'pi pi-upload' },
        { label: 'Exportar', value: 'exportar', icon: 'pi pi-download' }
      ]"
      [(ngModel)]="modoFicheros"
      (ngModelChange)="cambiarModoFicheros($event)"
      optionLabel="label"
      optionValue="value"
      [style]="{ width: '100%' }"
    ></p-selectButton>
  </div>

  <!-- Formulario de Importar -->
  <div *ngIf="modoFicheros === 'importar'">
    <div class="flex flex-column gap-3" [formGroup]="importForm">
      <div class="grid">
        <div class="col-12 md:col-8 h-full">
          <label class="block mb-2">Tema</label>
          <app-tema-select
            [multiple]="false"
            [formControl]="importForm.controls['temaId']"
          ></app-tema-select>
        </div>
        <div class="col-12 md:col-4 h-full">
          <label class="block mb-2">Dificultad</label>
          <app-dificultad-dropdown
            [formControlDificultad]="importForm.controls['dificultad']"
            [isFlashcards]="true"
          ></app-dificultad-dropdown>
        </div>
      </div>

      <div>
        <label class="block mb-2">Archivo (.xlsx, .xls)</label>
        <p-fileUpload
          mode="advanced"
          [auto]="false"
          [multiple]="false"
          [showUploadButton]="false"
          [showCancelButton]="false"
          accept=".xlsx,.xls"
          (onSelect)="onPrimeFileSelect($event)"
          chooseLabel="Seleccionar / Arrastrar aquí"
          [style]="{ width: '100%' }"
        ></p-fileUpload>
      </div>

      <div class="grid">
        <div class="col-12 md:col-6">
          <h4>Estructura esperada</h4>
          <p>Columnas mínimas (en español):</p>
          <ul>
            <li><code>Descripción</code></li>
            <li><code>Solución</code></li>
          </ul>
        </div>
        <div class="col-12 md:col-6">
          <h4>Notas</h4>
          <ul>
            <li>Puedes incluir más columnas, se ignorarán.</li>
          </ul>
          <div class="mt-2">
            <p-button
              label="Descargar plantilla Excel"
              icon="pi pi-download"
              styleClass="p-button-text"
              (click)="descargarPlantillaFlashcards()"
            ></p-button>
          </div>
        </div>
      </div>
    </div>
    <div class="flex justify-content-end gap-2 mt-3">
      <p-button
        label="Cancelar"
        styleClass="p-button-outlined"
        (click)="mostrarFicherosDialog = false"
      ></p-button>
      <p-button
        label="Importar"
        icon="pi pi-upload"
        (click)="importarFlashcards()"
        [disabled]="!selectedFile || importForm.invalid"
      ></p-button>
    </div>
  </div>

  <!-- Formulario de Exportar -->
  <div *ngIf="modoFicheros === 'exportar'">
    <div class="flex flex-column gap-3" [formGroup]="exportForm">
      <div class="grid">
        <div class="col-12 md:col-8 h-full">
          <label class="block mb-2">Tema</label>
          <app-tema-select
            [multiple]="false"
            [formControl]="exportForm.controls['temaId']"
          ></app-tema-select>
        </div>
        <div class="col-12 md:col-4 h-full">
          <label class="block mb-2">Dificultad</label>
          <app-dificultad-dropdown
            [formControlDificultad]="exportForm.controls['dificultad']"
            [isFlashcards]="true"
          ></app-dificultad-dropdown>
        </div>
      </div>

      <div>
        <label class="block mb-2">Formato de exportación</label>
        <p-dropdown
          [formControl]="exportForm.controls['formato']"
          [options]="[
            { label: 'Excel (.xlsx)', value: 'excel' },
            { label: 'Word (.docx)', value: 'word' }
          ]"
          placeholder="Seleccionar formato"
          optionLabel="label"
          optionValue="value"
          styleClass="w-full"
        ></p-dropdown>
      </div>

      <div class="grid">
        <div class="col-12 md:col-6">
          <h4>Información incluida</h4>
          <ul>
            <li>Identificador de la flashcard</li>
            <li>Tema</li>
            <li>Descripción</li>
            <li>Solución</li>
          </ul>
        </div>
        <div class="col-12 md:col-6">
          <h4>Información adicional</h4>
          <ul>
            <li>Dificultad</li>
            <li>Relevancia/Comunidad</li>
            <li>Información del creador</li>
          </ul>
        </div>
      </div>
    </div>
    <div class="flex justify-content-end gap-2 mt-3">
      <p-button
        label="Cancelar"
        styleClass="p-button-outlined"
        (click)="mostrarFicherosDialog = false"
      ></p-button>
      <p-button
        [label]="exportForm.value.formato === 'excel' ? 'Exportar Excel' : 'Exportar Word'"
        [icon]="exportForm.value.formato === 'excel' ? 'pi pi-file-excel' : 'pi pi-file-word'"
        (click)="exportarFlashcards()"
        [loading]="exportando"
        [disabled]="exportForm.invalid"
      ></p-button>
    </div>
  </div>
</p-dialog>

<!-- Template para el item de flashcard -->
<ng-template #flashcardItemTemplate let-item>
  <div class="flex flex-row align-items-between">
    <div class="flex flex-column py-2 col-9 left-side truncate-flex-content">
      <div class="text-lg font-medium flex gap-2 align-items-center">
        <div class="flex gap-1">
          <strong
            class="identifier"
            pTooltip="{{ item.identificador }}"
            tooltipPosition="top"
            >{{ item.identificador }}</strong
          >
        </div>
        <div class="flex gap-1 align-items-center">
          <ng-container *ngIf="expectedRole == 'ADMIN'">
            <i
              class="pi pi-{{ star }}"
              *ngFor="let star of getStarsBasedOnDifficulty(item.dificultad)"
              pTooltip="Dificultad: {{ item.dificultad }}"
              tooltipPosition="top"
            ></i>
          </ng-container>
        </div>
        <div class="flex gap-1">
          <span
            class="badge bg-primary text-white"
            pTooltip="Tema: {{ item.tema.numero }}"
            tooltipPosition="top"
          >
            Tema {{ item.tema.numero }}
          </span>
        </div>
      </div>
      <span
        class="descripcion"
        pTooltip="{{ item.descripcion }}"
        tooltipPosition="top"
        >{{
          item.descripcion && item.descripcion.length > 0
            ? item.descripcion
            : "Sin descripción"
        }}</span
      >
    </div>
    <div class="right-side col-3 flex align-items-center justify-content-end">
      <div class="flex flex-row align-items-center justify-content-end gap-2">
        <app-oposicion-picker
          [oposiciones]="item.relevancia"
        ></app-oposicion-picker>
        <span
          class="text-xs hidden md:block unbreakable-text"
          pTooltip="Fecha de creación: {{
            item.createdAt | date : 'dd/MM/yyyy HH:mm'
          }}"
          tooltipPosition="top"
        >
          {{ item.createdAt | date : "short" }}</span
        >
        <p-button
          (click)="
            $event.stopPropagation();
            $event.preventDefault();
            eliminarFlashcard(item.id, $event)
          "
          icon="pi pi-trash"
          pTooltip="Eliminar flashcard"
          styleClass="p-button-danger"
        ></p-button>
        <p-button
          (click)="
            $event.stopPropagation();
            $event.preventDefault();
            navigateToDetailview(item.id)
          "
          icon="pi pi-pencil"
          pTooltip="Editar flashcard"
        ></p-button>
      </div>
    </div>
  </div>
</ng-template>
