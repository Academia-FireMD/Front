<p-confirmDialog />

<app-generic-list
  [fetchItems$]="fetchItems$"
  [itemTemplate]="userItemTemplate"
  [filters]="filters"
  (onItemClick)="onItemClick($event)"
  (filtersChanged)="onFiltersChanged($event)"
>
  <div left-actions>
    <p-iconField iconPosition="left" class="flex-grow-1">
      <p-inputIcon styleClass="pi pi-search" />
      <input
        type="text"
        pInputText
        placeholder="Buscar por email"
        [value]="pagination().searchTerm"
        (input)="valueChanged($event)"
        class="w-full"
      />
    </p-iconField>
  </div>

  <div empty-template>
    <div class="text-center p-4">
      No hay usuarios disponibles
    </div>
  </div>
</app-generic-list>

<!-- Template para el item de usuario -->
<ng-template #userItemTemplate let-item>
  <div class="flex flex-row align-items-between">
    <div class="flex flex-column py-2 col-9 left-side truncate-flex-content">
      <div class="text-lg font-medium flex gap-2 align-items-center">
        <span class="identifier" pTooltip="{{ item.email }}" tooltipPosition="top">
          @if (item.nombre && item.apellidos && item.nombre.length>0 &&
          item.apellidos.length>0 && viewportService.screenWidth!= 'xs')
          {
          {{ item.nombre + " " + item.apellidos }}
          <span class="font-small">{{
            " ( " + item.email + " ) "
          }}</span>
          } @else {
          {{ item.email }}
          }
        </span>
        
        <div class="flex gap-1">
          <p-chip
            [styleClass]="item.validated ? 'verified-chip' : 'nonverified-chip'"
            label="{{
              item.validated ? 'Verificado' : 'Sin verificar'
            }}"
            pTooltip="{{ item.validated ? 'Usuario verificado' : 'Usuario sin verificar' }}"
            tooltipPosition="top"
          />
          <p-chip
            [styleClass]="item.rol == 'ADMIN' ? 'admin-chip' : 'alumno-chip'"
            label="{{ item.rol == 'ADMIN' ? 'Admin' : 'Alumno' }}"
            pTooltip="{{ item.rol == 'ADMIN' ? 'Usuario administrador' : 'Usuario alumno' }}"
            tooltipPosition="top"
          />
          <p-chip
            *ngIf="item.esTutor"
            styleClass="tutor-chip"
            label="Tutor"
            pTooltip="Usuario tutor"
            tooltipPosition="top"
          />
          <p-chip
            [styleClass]="getSubscriptionBadgeClass(item.suscripcion)"
            [label]="getSubscriptionLabel(item.suscripcion)"
            pTooltip="Tipo de suscripción"
            tooltipPosition="top"
          />
        </div>
      </div>
      <span class="descripcion unbreakable-text" pTooltip="Fecha de solicitud" tooltipPosition="top">
        {{
          viewportService.screenWidth != "xs"
            ? "Solicitado el día"
            : ""
        }}
        {{ item.createdAt | date : "short" }}
      </span>
    </div>

    <div class="right-side col-3 flex align-items-center justify-content-end">
      <div class="flex flex-row align-items-center justify-content-end gap-2">
        <p-splitButton
          [label]="
            viewportService.screenWidth != 'xs' ? 'Permitir' : ''
          "
          icon="pi pi-check"
          [model]="getActionItems(item)"
          (onClick)="permitir(item.id)"
          styleClass="p-button-sm p-button-raised action-split-button"
          appendTo="body"
          (click)="$event.stopPropagation()"
        ></p-splitButton>
      </div>
    </div>
  </div>
</ng-template>

<!-- Diálogo para cambiar suscripción -->
<p-dialog
  header="Cambiar Suscripción"
  [(visible)]="subscriptionDialogVisible"
  [modal]="true"
  [style]="{ width: '450px' }"
  [draggable]="false"
  [resizable]="false"
>
  <div class="flex flex-column gap-3">
    <div class="flex flex-column gap-2">
      <label class="font-medium">Usuario:</label>
      <span
        >{{ selectedUser?.nombre }} {{ selectedUser?.apellidos }} ({{
          selectedUser?.email
        }})</span
      >
    </div>

    <div class="flex flex-column gap-2">
      <label class="font-medium">Suscripción actual:</label>
      <p-chip
        [ngClass]="getSubscriptionBadgeClass(selectedUser?.suscripcion)"
        [label]="getSubscriptionLabel(selectedUser?.suscripcion)"
      />
    </div>

    <div class="flex flex-column gap-2">
      <label class="font-medium">Nueva suscripción:</label>
      <p-dropdown
        [options]="availableSubscriptions"
        [(ngModel)]="selectedSubscriptionType"
        optionLabel="name"
        optionValue="id"
        placeholder="Selecciona una suscripción"
        [style]="{ width: '100%' }"
        appendTo="body"
      />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        (click)="subscriptionDialogVisible = false"
        [text]="true"
      />
      <p-button
        label="Actualizar"
        icon="pi pi-check"
        (click)="updateUserSubscription()"
        [loading]="false"
      />
    </div>
  </ng-template>
</p-dialog>
