<p-confirmDialog />

<app-generic-list
  [fetchItems$]="fetchItems$"
  [itemTemplate]="userItemTemplate"
  [filters]="filters()"
  [mode]="mode"
  [selectedItemIds]="selectedUserIds"
  [getItemId]="getUserId"
  (onItemClick)="onItemClick($event)"
  (filtersChanged)="onFiltersChanged($event)"
  (selectionChange)="onSelectionChange($event)"
>
  <div left-actions>
    <p-iconField iconPosition="left" class="flex-grow-1">
      <p-inputIcon styleClass="pi pi-search" />
      <input
        type="text"
        pInputText
        placeholder="Buscar por email"
        [value]="pagination().searchTerm"
        (input)="valueChanged($event)"
        class="w-full"
      />
    </p-iconField>
  </div>

  <div empty-template>
    <div class="text-center p-4">No hay usuarios disponibles</div>
  </div>
</app-generic-list>

<!-- Template para el item de usuario -->
<ng-template
  #userItemTemplate
  let-item
  let-mode="mode"
  let-isSelected="isSelected"
>
  <div class="flex flex-row align-items-between">
    <div
      class="flex flex-column py-2 left-side truncate-flex-content"
      [ngClass]="mode === 'selection' ? 'col-9' : 'col-9'"
    >
      <div class="text-lg font-medium flex gap-2 align-items-center">
        <span
          class="identifier"
          pTooltip="{{ item.email }}"
          tooltipPosition="top"
        >
          @if (item.nombre && item.apellidos && item.nombre.length>0 &&
          item.apellidos.length>0 && viewportService.screenWidth!= 'xs') {
          {{ item.nombre + " " + item.apellidos }}
          <span class="font-small">{{ " ( " + item.email + " ) " }}</span>
          } @else {
          {{ item.email }}
          }
        </span>

        <div class="flex gap-1">
          <p-chip
            [styleClass]="item.validated ? 'verified-chip' : 'nonverified-chip'"
            label="{{ item.validated ? 'Verificado' : 'Sin verificar' }}"
            pTooltip="{{
              item.validated ? 'Usuario verificado' : 'Usuario sin verificar'
            }}"
            tooltipPosition="top"
          />
          <p-chip
            [styleClass]="item.rol == 'ADMIN' ? 'admin-chip' : 'alumno-chip'"
            label="{{ item.rol == 'ADMIN' ? 'Admin' : 'Alumno' }}"
            pTooltip="{{
              item.rol == 'ADMIN' ? 'Usuario administrador' : 'Usuario alumno'
            }}"
            tooltipPosition="top"
          />
          <p-chip
            *ngIf="item.esTutor"
            styleClass="tutor-chip"
            label="Tutor"
            pTooltip="Usuario tutor"
            tooltipPosition="top"
          />
          @if (item.woocommerceCustomerId) {
            <p-chip
              styleClass="wp-chip"
              label="WP"
              pTooltip="Usuario vinculado a WordPress - gestiona sus suscripciones desde su panel"
              tooltipPosition="top"
            />
          }
          @if (item.suscripciones && item.suscripciones.length > 0) {
            @for (sub of item.suscripciones; track sub.id) {
              <p-chip
                [styleClass]="getSubscriptionBadgeClass(sub)"
                [label]="getSubscriptionLabel(sub)"
                [pTooltip]="'Suscripción: ' + getSubscriptionLabel(sub)"
                tooltipPosition="top"
              />
            }
          } @else {
            <p-chip
              styleClass="no-subscription-chip"
              label="Sin suscripción"
              pTooltip="Usuario sin suscripción"
              tooltipPosition="top"
            />
          }
          @if (item.labels && item.labels.length > 0) {
            @for (userLabel of item.labels; track userLabel.labelId) {
              <p-chip
                styleClass="label-chip"
                [pTooltip]="'Etiqueta: ' + userLabel.label.key + (userLabel.label.value ? ' = ' + userLabel.label.value : '')"
                tooltipPosition="top"
              >
                <i class="pi pi-tag mr-1"></i>
                <span class="font-medium">{{ userLabel.label.key }}</span>
                @if (userLabel.label.value) {
                  <span class="ml-1">: {{ userLabel.label.value }}</span>
                }
              </p-chip>
            }
          }
        </div>
      </div>
      <span
        class="descripcion unbreakable-text"
        pTooltip="Fecha de solicitud"
        tooltipPosition="top"
      >
        {{ viewportService.screenWidth != "xs" ? "Solicitado el día" : "" }}
        {{ item.createdAt | date : "short" }}
      </span>
    </div>

    <div
      *ngIf="mode === 'overview'"
      class="right-side col-3 flex align-items-center justify-content-end"
    >
      <div class="flex flex-row align-items-center justify-content-end gap-2">
        @if (decodedUser.rol === 'ADMIN') {
        <p-button
          icon="pi pi-angle-down"
          [style]="{
            transform: isUserExpanded(item.id)
              ? 'rotate(180deg)'
              : 'rotate(0deg)'
          }"
          styleClass="p-button-sm p-button-text p-button-rounded"
          (click)="toggleUserExpansion(item.id, $event)"
          pTooltip="Ver planificaciones"
          tooltipPosition="top"
        />
        }
        <p-splitButton
          [label]="viewportService.screenWidth != 'xs' ? (item.validated ? 'Dar de baja' : 'Verificar') : ''"
          [icon]="item.validated ? 'pi pi-ban' : 'pi pi-check'"
          [model]="getActionItems(item)"
          (onClick)="item.validated ? denegar(item.id, $event) : permitir(item.id)"
          [styleClass]="'p-button-sm p-button-raised action-split-button no-wrap-button ' + (item.validated ? 'p-button-danger' : 'p-button-success')"
          appendTo="body"
          (click)="$event.stopPropagation()"
        ></p-splitButton>
      </div>
    </div>
  </div>

  <!-- Expansión de planificaciones e información del usuario -->
  @if (decodedUser.rol === 'ADMIN' && isUserExpanded(item.id)) {
  <div class="col-12 mt-2 planifications-expansion">
    <div class="p-3 border-1 border-round surface-border">
      <!-- Tabs para planificaciones e información personal -->
      <p-tabView>
        <p-tabPanel header="Planificaciones" leftIcon="pi pi-calendar">
          <div class="planifications-content">
            @if (isLoadingPlanifications(item.id)) {
            <div class="text-center py-3">
              <p-progressSpinner styleClass="small-spinner" />
              <p class="text-sm text-500">Cargando planificaciones...</p>
            </div>
            } @else if (getUserPlanifications(item.id).length === 0) {
            <div class="text-center py-3">
              <i class="pi pi-calendar-times text-400 text-xl"></i>
              <p class="text-sm text-500 mt-2">
                No tiene planificaciones asignadas
              </p>
            </div>
            } @else {
            <div class="grid">
              @for (asignacion of getUserPlanifications(item.id); track
              asignacion.id) {
              <div class="col-12 lg:col-6">
                <div
                  class="p-3 border-1 border-round-md surface-50 planification-card"
                >
                  <div class="flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <h6 class="m-0 mb-2 text-primary">
                        {{ asignacion.planificacion.identificador }}
                      </h6>
                      <p class="text-sm text-600 m-0 mb-2">
                        {{ asignacion.planificacion.descripcion }}
                      </p>
                      <div
                        class="flex gap-2 align-items-center text-xs text-500"
                      >
                        <i class="pi pi-calendar"></i>
                        <span
                          >Asignada:
                          {{ asignacion.createdAt | date : "short" }}</span
                        >
                      </div>
                      @if (asignacion.planificacion.subBloques) {
                      <div
                        class="flex gap-2 align-items-center text-xs text-500 mt-1"
                      >
                        <i class="pi pi-list"></i>
                        <span
                          >{{
                            asignacion.planificacion.subBloques.length
                          }}
                          subbloques</span
                        >
                      </div>
                      }
                    </div>
                    <div class="flex flex-column gap-1">
                      <p-button
                        icon="pi pi-eye"
                        styleClass="p-button-sm p-button-text"
                        pTooltip="Ver planificación"
                        tooltipPosition="left"
                        (click)="
                          verPlanificacion(asignacion.planificacion.id);
                          $event.stopPropagation()
                        "
                      />
                      <p-button
                        icon="pi pi-times"
                        styleClass="p-button-sm p-button-text p-button-danger"
                        pTooltip="Desvincular"
                        tooltipPosition="left"
                        (click)="
                          desvincularPlanificacion(
                            asignacion.planificacion.id,
                            item.id
                          );
                          $event.stopPropagation()
                        "
                      />
                    </div>
                  </div>
                </div>
              </div>
              }
            </div>
            }
          </div>
        </p-tabPanel>

        <p-tabPanel header="Información Personal" leftIcon="pi pi-user-plus">
          <div class="user-onboarding-info">
            <div class="onboarding-summary mb-3">
              <div class="flex justify-content-between align-items-center mb-2">
                <span class="font-medium">Información completada:</span>
                <span class="completion-percentage"
                  >{{ getOnboardingCompletionPercentage(item) }}%</span
                >
              </div>
              <div class="completion-bar">
                <div
                  class="completion-fill"
                  [style.width.%]="getOnboardingCompletionPercentage(item)"
                  [ngClass]="{
                    low: getOnboardingCompletionPercentage(item) < 30,
                    medium:
                      getOnboardingCompletionPercentage(item) >= 30 &&
                      getOnboardingCompletionPercentage(item) < 70,
                    high: getOnboardingCompletionPercentage(item) >= 70
                  }"
                ></div>
              </div>
            </div>

            <!-- Tabs para organizar mejor la información -->
            <p-tabView>
              <!-- Información Principal -->
              <p-tabPanel
                header="Información Principal"
                leftIcon="pi pi-info-circle"
              >
                <div class="onboarding-fields grid">
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Tipo de oposición:</label>
                      <span>{{
                        item.tipoOposicion || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Nivel:</label>
                      <span>{{
                        item.nivelOposicion || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Tipo de planificación deseada:</label>
                      <span>{{
                        item.tipoDePlanificacionDuracionDeseada ||
                          "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <!--
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Planificación seleccionada:</label>
                      <span>{{ item.planificacionSeleccionada || 'No proporcionado' }}</span>
                    </div>
                  </div> -->
                </div>
              </p-tabPanel>

              <!-- Datos Personales -->
              <p-tabPanel header="Datos Personales" leftIcon="pi pi-user">
                <div class="onboarding-fields grid">
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>DNI:</label>
                      <span>{{ item.dni || "No proporcionado" }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Fecha de nacimiento:</label>
                      <span>{{
                        item.fechaNacimiento
                          ? (item.fechaNacimiento | date : "dd/MM/yyyy")
                          : "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Teléfono:</label>
                      <span>{{ item.telefono || "No proporcionado" }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Empresa:</label>
                      <span>{{
                        item.nombreEmpresa || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>País/Región:</label>
                      <span>{{ item.paisRegion || "No proporcionado" }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Provincia:</label>
                      <span>{{ item.provincia || "No proporcionado" }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Dirección:</label>
                      <span>{{
                        item.direccionCalle || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-4">
                    <div class="info-field">
                      <label>Código Postal:</label>
                      <span>{{ item.codigoPostal || "No proporcionado" }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-4">
                    <div class="info-field">
                      <label>Población:</label>
                      <span>{{ item.poblacion || "No proporcionado" }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-4">
                    <div class="info-field">
                      <label>Municipio Residencia:</label>
                      <span>{{
                        item.municipioResidencia || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                </div>
              </p-tabPanel>

              <!-- Formación y Experiencia -->
              <p-tabPanel header="Formación" leftIcon="pi pi-book">
                <div class="onboarding-fields grid">
                  <div class="col-12">
                    <div class="info-field">
                      <label>Estudios previos:</label>
                      <span>{{
                        item.estudiosPrevaios || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Trabajo actual/ocupación:</label>
                      <span>{{
                        item.actualTrabajoOcupacion || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Hobbies:</label>
                      <span>{{ item.hobbies || "No proporcionado" }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Descripción de la semana:</label>
                      <span>{{
                        item.descripcionSemana || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Experiencia en temario:</label>
                      <span>{{ item.temaPersonal || "No proporcionado" }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Oposiciones hechas y resultados:</label>
                      <span>{{
                        item.oposicionesHechasResultados || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Pruebas físicas:</label>
                      <span>{{
                        item.pruebasFisicas || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Técnicas de estudio utilizadas:</label>
                      <span>{{
                        item.tecnicasEstudioUtilizadas || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                </div>
              </p-tabPanel>

              <!-- Planificación -->
              <p-tabPanel header="Planificación" leftIcon="pi pi-calendar">
                <div class="onboarding-fields grid">
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Horas estudio/día:</label>
                      <span>{{
                        item.horasEstudioDiaSemana
                          ? item.horasEstudioDiaSemana + "h"
                          : "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Horas entreno/día:</label>
                      <span>{{
                        item.horasEntrenoDiaSemana
                          ? item.horasEntrenoDiaSemana + "h"
                          : "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Organización estudio y entrenamiento:</label>
                      <span>{{
                        item.organizacionEstudioEntreno || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>¿Trabajas actualmente?:</label>
                      <span>{{
                        item.trabajasActualmente || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Agotamiento físico y mental:</label>
                      <span>{{
                        item.agotamientoFisicoMental || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Tiempo dedicable al estudio:</label>
                      <span>{{
                        item.tiempoDedicableEstudio || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Días semana disponibles:</label>
                      <span>{{
                        item.diasSemanaDisponibles || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Otra información laboral:</label>
                      <span>{{
                        item.otraInformacionLaboral || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                </div>
              </p-tabPanel>

              <!-- Objetivos -->
              <p-tabPanel header="Objetivos" leftIcon="pi pi-target">
                <div class="onboarding-fields grid">
                  <div class="col-12">
                    <div class="info-field">
                      <label>Objetivos a 6 meses:</label>
                      <span>{{
                        item.objetivosSeisMeses || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>Objetivos a 1 año:</label>
                      <span>{{
                        item.objetivosUnAno || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                </div>
              </p-tabPanel>

              <!-- Academia -->
              <p-tabPanel header="Academia" leftIcon="pi pi-building">
                <div class="onboarding-fields grid">
                  <div class="col-12 md:col-6">
                    <div class="info-field">
                      <label>Experiencia en academias:</label>
                      <span
                        [ngClass]="
                          item.experienciaAcademias ? 'badge-yes' : 'badge-no'
                        "
                      >
                        {{ item.experienciaAcademias ? "Sí" : "No" }}
                      </span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>¿Qué valoras en una academia?:</label>
                      <span>{{
                        item.queValorasAcademia || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>¿Qué menos te gusta de las academias?:</label>
                      <span>{{
                        item.queMenosGustaAcademias || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="info-field">
                      <label>¿Qué esperas de esta academia?:</label>
                      <span>{{
                        item.queEsperasAcademia || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                </div>
              </p-tabPanel>

              <!-- Comentarios -->
              <p-tabPanel header="Comentarios" leftIcon="pi pi-comment">
                <div class="onboarding-fields grid">
                  <div class="col-12">
                    <div class="info-field">
                      <label>Comentarios adicionales:</label>
                      <span>{{
                        item.comentariosAdicionales || "No proporcionado"
                      }}</span>
                    </div>
                  </div>
                </div>
              </p-tabPanel>
            </p-tabView>

            @if (getOnboardingCompletionPercentage(item) < 50) {
            <div class="onboarding-alert mt-3">
              <div class="alert-content">
                <i class="pi pi-info-circle"></i>
                <span
                  >El alumno tiene poca información completada. Considera
                  contactarle para completar su perfil.</span
                >
              </div>
            </div>
            }
          </div>
        </p-tabPanel>
      </p-tabView>
    </div>
  </div>
  }
</ng-template>

<!-- Diálogo para gestionar suscripciones -->
<p-dialog
  header="Gestionar Suscripciones"
  [(visible)]="subscriptionDialogVisible"
  [modal]="true"
  [style]="{ width: '550px' }"
  [draggable]="false"
  [resizable]="false"
>
  <div class="flex flex-column gap-4">
    <!-- Info del usuario -->
    <div class="flex flex-column gap-2">
      <label class="font-medium">Usuario:</label>
      <span class="text-700">
        {{ selectedUser?.nombre }} {{ selectedUser?.apellidos }}
        <span class="text-500">({{ selectedUser?.email }})</span>
      </span>
    </div>

    <!-- Suscripciones actuales -->
    <div class="flex flex-column gap-2">
      <label class="font-medium">Suscripciones actuales:</label>
      @if (selectedUser?.suscripciones?.length) {
        <div class="flex flex-column gap-2">
          @for (sub of selectedUser?.suscripciones || []; track sub.id) {
            <div class="flex align-items-center justify-content-between p-3 surface-50 border-round">
              <div class="flex align-items-center gap-2">
                <p-chip
                  [styleClass]="getSubscriptionBadgeClass(sub)"
                  [label]="getSubscriptionLabel(sub)"
                />
                <span
                  class="text-xs px-2 py-1 border-round"
                  [ngClass]="{
                    'bg-green-100 text-green-700': sub.status === 'ACTIVE',
                    'bg-red-100 text-red-700': sub.status === 'CANCELLED'
                  }"
                >
                  {{ sub.status === 'ACTIVE' ? 'Activa' : 'Cancelada' }}
                </span>
              </div>
              <p-button
                icon="pi pi-trash"
                styleClass="p-button-danger p-button-text p-button-sm"
                pTooltip="Eliminar suscripción"
                tooltipPosition="left"
                (onClick)="deleteSubscription(sub)"
              />
            </div>
          }
        </div>
      } @else {
        <div class="p-3 surface-50 border-round text-center text-500">
          <i class="pi pi-info-circle mr-2"></i>
          Sin suscripciones
        </div>
      }
    </div>

    <p-divider />

    <!-- Añadir nueva suscripción -->
    <div class="flex flex-column gap-3">
      <label class="font-medium">Añadir nueva suscripción:</label>

      <div class="grid">
        <div class="col-6">
          <label class="text-sm text-600 block mb-2">Oposición</label>
          <p-dropdown
            [options]="oposicionOptions"
            [(ngModel)]="selectedOposicion"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecciona oposición"
            [style]="{ width: '100%' }"
            appendTo="body"
          >
            <ng-template let-option pTemplate="item">
              <div class="flex align-items-center justify-content-between w-full">
                <span>{{ option.label }}</span>
                <i *ngIf="hasSubscriptionForOposicion(option.value)"
                   class="pi pi-check-circle text-green-500 ml-2"
                   pTooltip="Ya tiene suscripción"
                   tooltipPosition="left"></i>
              </div>
            </ng-template>
          </p-dropdown>
          <small *ngIf="hasSubscriptionForOposicion(selectedOposicion)" class="text-orange-500">
            <i class="pi pi-exclamation-triangle mr-1"></i>
            Ya existe suscripción para esta oposición
          </small>
        </div>
        <div class="col-6">
          <label class="text-sm text-600 block mb-2">Tipo de plan</label>
          <p-dropdown
            [options]="subscriptionTypeOptions"
            [(ngModel)]="selectedSubscriptionType"
            optionLabel="label"
            optionValue="value"
            placeholder="Selecciona plan"
            [style]="{ width: '100%' }"
            appendTo="body"
          />
        </div>
      </div>

      <p-button
        label="Añadir suscripción"
        icon="pi pi-plus"
        styleClass="w-full"
        (onClick)="updateUserSubscription()"
        [disabled]="!canAddSubscription()"
        [pTooltip]="hasSubscriptionForOposicion(selectedOposicion) ? 'Ya existe una suscripción para esta oposición' : ''"
        tooltipPosition="top"
      />
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end">
      <p-button
        label="Cerrar"
        icon="pi pi-times"
        (click)="subscriptionDialogVisible = false"
        [text]="true"
      />
    </div>
  </ng-template>
</p-dialog>

<!-- Diálogo para gestionar Etiquetas -->
<p-dialog
  header="Gestionar Etiquetas"
  [(visible)]="labelsDialogVisible"
  [modal]="true"
  [style]="{ width: '600px' }"
  [draggable]="false"
  [resizable]="false"
>
  <div class="flex flex-column gap-4">
    <!-- Usuario -->
    <div class="flex flex-column gap-2">
      <label class="font-medium">Usuario:</label>
      <span class="text-700">{{ selectedUser?.nombre }} {{ selectedUser?.apellidos }}</span>
    </div>

    <!-- Etiquetas actuales del usuario -->
    <div class="flex flex-column gap-2">
      <label class="font-medium">Etiquetas actuales:</label>
      @if (userLabels.length === 0) {
        <div class="p-3 border-1 border-round surface-border text-center text-500">
          <i class="pi pi-tag mr-2"></i>
          Sin etiquetas asignadas
        </div>
      } @else {
        <div class="flex flex-wrap gap-2">
          @for (userLabel of userLabels; track userLabel.labelId) {
            <p-chip>
              <span class="font-medium">{{ userLabel.label.key }}</span>
              @if (userLabel.label.value) {
                <span class="ml-1 text-500">: {{ userLabel.label.value }}</span>
              }
              <i
                class="pi pi-times ml-2 cursor-pointer"
                (click)="removeUserLabel(userLabel.labelId)"
                pTooltip="Eliminar etiqueta"
              ></i>
            </p-chip>
          }
        </div>
      }
    </div>

    <p-divider />

    <!-- Pestañas para asignar o crear -->
    <p-tabView>
      <!-- Asignar etiqueta existente -->
      <p-tabPanel header="Asignar existente" leftIcon="pi pi-tags">
        <div class="flex flex-column gap-3">
          <div class="flex flex-column gap-2">
            <label class="font-medium">Seleccionar etiqueta:</label>
            <p-dropdown
              [options]="availableLabels"
              [(ngModel)]="selectedLabelId"
              optionValue="id"
              appendTo="body"
              [filter]="true"
              placeholder="Selecciona una etiqueta"
              [style]="{ width: '100%' }"
            >
              <ng-template pTemplate="selectedItem" let-option>
                <span class="font-medium">{{ option.key }}</span>
                @if (option.value) {
                  <span class="ml-1 text-500">: {{ option.value }}</span>
                }
              </ng-template>
              <ng-template pTemplate="item" let-option>
                <div class="flex flex-column">
                  <span class="font-medium">{{ option.key }}</span>
                  @if (option.value) {
                    <span class="text-sm text-500">{{ option.value }}</span>
                  }
                </div>
              </ng-template>
            </p-dropdown>
          </div>
          <p-button
            label="Asignar"
            icon="pi pi-check"
            (click)="assignSelectedLabelToUser()"
            [disabled]="!selectedLabelId"
            styleClass="w-full"
          />
        </div>
      </p-tabPanel>

      <!-- Crear nueva etiqueta -->
      <p-tabPanel header="Crear nueva" leftIcon="pi pi-plus-circle">
        <div class="flex flex-column gap-3">
          <div class="flex flex-column gap-2">
            <label class="font-medium">
              Clave: <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              pInputText
              [(ngModel)]="newLabelKey"
              placeholder="ej: cohorte, nivel, sede"
              class="w-full"
            />
            <small class="text-color-secondary">
              Identificador único de la etiqueta (ej: cohorte, nivel, sede)
            </small>
          </div>

          <div class="flex flex-column gap-2">
            <label class="font-medium">Valor (opcional):</label>
            <input
              type="text"
              pInputText
              [(ngModel)]="newLabelValue"
              placeholder="ej: 2025A, B1, Valencia"
              class="w-full"
            />
            <small class="text-color-secondary">
              Valor específico de la etiqueta (ej: 2025A, B1, Valencia)
            </small>
          </div>

          <p-button
            label="Crear y asignar"
            icon="pi pi-plus"
            (click)="createAndAssignLabel()"
            [disabled]="!newLabelKey.trim()"
            styleClass="w-full"
          />
        </div>
      </p-tabPanel>
    </p-tabView>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end">
      <p-button
        label="Cerrar"
        icon="pi pi-times"
        (click)="closeLabelsDialog()"
        [text]="true"
      />
    </div>
  </ng-template>
</p-dialog>
