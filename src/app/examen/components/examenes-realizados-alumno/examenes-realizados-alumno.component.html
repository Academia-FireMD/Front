<p-dialog
  [(visible)]="showOptionsDialog"
  [modal]="true"
  [dismissableMask]="true"
  [closeOnEscape]="true"
  header="¿Qué deseas hacer con este examen?"
  [style]="{ width: '90%', maxWidth: '600px' }"
  [breakpoints]="{ '960px': '75vw', '640px': '90vw' }"
>
  <div class="grid p-fluid" *ngIf="!!selectedTest">
    <div class="col-12">
      <h3>Intentos realizados</h3>
      <div class="intentos-list">
        <div
          *ngFor="
            let intento of selectedTest.intentos.slice().reverse();
            let i = index;
            let last = last
          "
          class="intento-item p-3 mb-2"
          [ngClass]="{ 'first-attempt': last }"
        >
          <div class="flex align-items-center justify-content-between">
            <div class="flex flex-column">
              <span class="font-medium mb-2">
                <ng-container *ngIf="last">
                  <i class="pi pi-flag text-primary"></i> Primer intento
                  (registrado)
                </ng-container>
                <ng-container *ngIf="!last && i === 0">Último intento</ng-container>
                <ng-container *ngIf="!last && i !== 0"
                  >Intento anterior</ng-container
                >
                <span class="text-sm text-secondary">
                  ({{ intento.fechaRealizacion | date : "dd/MM/yyyy HH:mm" }})
                </span>
              </span>
              <div class="flex gap-3 text-sm">
                <span class="flex align-items-center gap-1">
                  <i class="pi pi-check-circle text-green-500"></i>
                  {{ intento.correctas }} correctas
                </span>
                <span class="flex align-items-center gap-1">
                  <i class="pi pi-times-circle text-red-500"></i>
                  {{ intento.incorrectas }} incorrectas
                </span>
                <span class="flex align-items-center gap-1">
                  <i
                    class="pi pi-star-fill"
                    [ngClass]="getNotaClass(intento.nota)"
                  ></i>
                  {{ intento.nota.toFixed(2) }}
                </span>
              </div>
            </div>
            <div class="flex gap-2">
              <p-button
                icon="pi pi-eye"
                styleClass="p-button-rounded p-button-outlined p-button-primary"
                pTooltip="Ver respuestas"
                (onClick)="
                  verRespuestas(intento.idTest); showOptionsDialog = false
                "
              ></p-button>
              <p-button
                icon="pi pi-chart-bar"
                styleClass="p-button-rounded p-button-outlined"
                pTooltip="Ver estadisticas"
                (onClick)="
                  verResultadosTest(intento.idTest); showOptionsDialog = false
                "
              ></p-button>

              <p-button
                icon="pi pi-chart-line"
                styleClass="p-button-rounded p-button-outlined p-button-primary"
                pTooltip="Ver ranking"
                (onClick)="
                  $event.stopPropagation();
                  verLeaderboard(selectedTest.idExamen, intento.idTest)
                "
              ></p-button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</p-dialog>

<app-generic-list
  [fetchItems$]="fetchItems$"
  [itemTemplate]="examenItemTemplate"
  [filters]="filters"
  (onItemClick)="onItemClick($event)"
  (filtersChanged)="onFiltersChanged($event)"
>
  <div left-actions>
    <p-iconField iconPosition="left">
      <p-inputIcon styleClass="pi pi-search"></p-inputIcon>
      <input
        type="text"
        pInputText
        placeholder="Buscar exámenes realizados"
        [value]="pagination().searchTerm"
        (input)="valueChanged($event)"
        data-testid="buscar-examenes-realizados-input"
        class="w-full"
      />
    </p-iconField>
  </div>

  <div empty-template>
    <div class="text-center p-4">No has realizado ningún examen todavía.</div>
  </div>
</app-generic-list>

<!-- Template para el item de examen -->
<ng-template #examenItemTemplate let-examen>
  <div class="flex flex-row align-items-between">
    <div class="flex flex-column py-2 col-9 left-side truncate-flex-content">
      <div class="text-lg font-medium flex gap-2 align-items-center">
        <span
          class="examen-titulo"
          pTooltip="{{ examen.titulo }}"
          tooltipPosition="top"
          >{{ examen.titulo }}</span
        >
        <p-badge
          *ngIf="examen.tieneMultiplesIntentos"
          [value]="examen.intentos.length + ' intentos'"
          severity="primary"
          pTooltip="Examen con múltiples intentos realizados"
          tooltipPosition="top"
        ></p-badge>
        <span
          class="badge bg-primary text-white"
          *ngIf="examen.tipoAcceso === 'SIMULACRO'"
          pTooltip="Examen tipo simulacro - Acceso restringido"
          tooltipPosition="top"
        >
          <i class="pi pi-stopwatch"></i> Simulacro
        </span>
        <span
          class="badge bg-purple-500 text-white"
          *ngIf="examen.tipoAcceso === 'COLABORATIVO'"
          pTooltip="Examen colaborativo - Requiere creación de preguntas"
          tooltipPosition="top"
        >
          <i class="pi pi-users"></i> Colaborativo
        </span>
      </div>
      <span
        class="descripcion"
        pTooltip="{{ examen.titulo }}"
        tooltipPosition="top"
      >
        Primer intento: {{ examen.correctas }} correctas /
        {{ examen.incorrectas }} incorrectas ({{
          examen.totalPreguntas
            ? ((examen.correctas / examen.totalPreguntas) * 100).toFixed(0)
            : 0
        }}% acierto)
      </span>
    </div>

    <div class="right-side col-3 flex align-items-center justify-content-end">
      <div class="flex flex-row align-items-center justify-content-end gap-2">
        <span class="text-sm font-medium flex align-items-center gap-2">
          <div
            class="nota-valor"
            [ngClass]="getNotaClass(examen.nota)"
            pTooltip="Nota del examen: {{
              examen.nota !== null ? examen.nota.toFixed(2) : 'N/A'
            }}"
            tooltipPosition="top"
          >
            {{ examen.nota !== null ? examen.nota.toFixed(2) : "N/A" }}
          </div>
        </span>
        <span class="text-xs hidden md:block unbreakable-text">
          {{ examen.fechaRealizacion | date : "dd/MM/yyyy HH:mm" }}
        </span>
        <p-button
          icon="pi pi-chart-line"
          styleClass="p-button-rounded p-button-outlined p-button-primary"
          pTooltip="Ver ranking"
          (onClick)="
            $event.stopPropagation();
            verLeaderboard(examen.idExamen, examen.idTest)
          "
        ></p-button>
      </div>
    </div>
  </div>
</ng-template>
