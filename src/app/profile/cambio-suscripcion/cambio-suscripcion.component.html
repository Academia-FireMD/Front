<div class="cambio-suscripcion-container">
  @if (validandoPlazo() || cargandoPlanes()) {
  <div class="loading-container">
    <p-progressSpinner />
    <p class="text-lg mt-3">Cargando información...</p>
  </div>
  } @else if (validacion && validacion.valido) {
  <div class="cambio-content">
    <div class="header-section">
      <div class="header-icon">
        <i class="pi pi-sync"></i>
      </div>
      <h1 class="header-title">Cambia tu plan de suscripción</h1>
      <p class="header-subtitle">
        Selecciona el nuevo plan que mejor se adapte a tus necesidades
      </p>
      <p class="header-note">
        <i class="pi pi-info-circle"></i>
        El cambio se aplicará en tu próxima facturación
      </p>
    </div>

    <div class="planes-section">
      @if (planesDisponibles.length === 0) {
      <div class="empty-state">
        <i class="pi pi-info-circle"></i>
        <p>No hay planes disponibles en este momento</p>
      </div>
      } @else {
      <div class="planes-scroll-container">
        <div class="planes-grid">
          @for (plan of planesDisponibles; track plan.id) {
          <div
            class="plan-card"
            [class.selected]="planSeleccionado?.id === plan.id"
            (click)="seleccionarPlan(plan)"
          >
            <div class="plan-radio">
              <p-radioButton
                [value]="plan"
                [(ngModel)]="planSeleccionado"
                [inputId]="'plan-' + plan.id"
              />
            </div>

            @if (plan.imageUrl) {
            <div class="plan-image">
              <img [src]="plan.imageUrl" [alt]="plan.name" />
            </div>
            }

            <div class="plan-content">
              <h3 class="plan-name">{{ plan.name }}</h3>

              <div class="plan-price-section">
                <span class="plan-price">{{ formatPrice(plan.price) }}€</span>
                <span class="plan-period">/mes</span>
              </div>

              @if (plan.description) {
              <div class="plan-description" [innerHTML]="plan.description"></div>
              }

              <div class="plan-sku">
                <small>SKU: {{ plan.sku }}</small>
              </div>
            </div>

            @if (planSeleccionado?.id === plan.id) {
            <div class="plan-selected-badge">
              <i class="pi pi-check-circle"></i>
              <span>Seleccionado</span>
            </div>
            }
          </div>
          }
        </div>
      </div>
      }

      <div class="comentario-section">
        <label for="comentario" class="comentario-label">
          <i class="pi pi-comment"></i>
          Comentario sobre el cambio (opcional)
        </label>
        <textarea
          pInputTextarea
          id="comentario"
          [(ngModel)]="comentario"
          rows="3"
          class="w-full"
          placeholder="¿Por qué deseas cambiar de plan?"
          [maxLength]="500"
        ></textarea>
        <small class="comentario-counter">{{ comentario.length }}/500</small>
      </div>
    </div>

    <div class="footer-actions">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        (onClick)="cancelar()"
        [outlined]="true"
        severity="secondary"
        styleClass="cancel-button"
      />
      <p-button
        label="Continuar con el cambio"
        icon="pi pi-check"
        (onClick)="abrirDialogConfirmacion()"
        [disabled]="!planSeleccionado"
        styleClass="confirm-button"
      />
    </div>
  </div>
  }
</div>
