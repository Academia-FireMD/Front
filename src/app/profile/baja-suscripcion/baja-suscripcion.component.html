<div class="baja-suscripcion-container">
  @if (validandoPlazo()) {
  <div class="loading-container">
    <p-progressSpinner />
    <p class="text-lg mt-3">Validando plazo de modificación...</p>
  </div>
  } @else if (validacion && validacion.valido) {
  <p-card header="Solicitud de Baja de Suscripción" styleClass="baja-card">
    <div class="header-content mb-4">
      <i class="pi pi-exclamation-triangle warning-icon"></i>
      <h2 class="mt-3">Lamentamos que hayas decidido darte de baja</h2>
      <p class="mt-2 text-700">
        Nos gustaría mejorar cada día y tu opinión es muy importante para
        nosotros.
      </p>
      <p class="text-700">
        Cuéntanos brevemente el motivo de tu baja o qué podríamos haber hecho
        mejor.
      </p>
      <p class="text-700 font-bold">
        ¡Gracias por tu tiempo y por haber formado parte de la comunidad
        Técnika Fire!
      </p>
    </div>

    <div class="form-section">
      <h3 class="mb-3">Motivos de baja</h3>
      <p class="text-sm text-500 mb-3">Selecciona uno o varios motivos:</p>

      <div class="motivos-grid">
        @for (option of motivosOptions; track option.value) {
        <div class="motivo-item">
          <p-checkbox
            [value]="option.value"
            [binary]="true"
            [ngModel]="isMotivoSelected(option.value)"
            (onChange)="onMotivoChange(option.value, $event.checked)"
            [inputId]="'motivo-' + option.value"
          />
          <label [for]="'motivo-' + option.value" class="ml-2">
            {{ option.label }}
          </label>
        </div>
        }
      </div>

      <div class="mt-4">
        <label for="comentario" class="block mb-2 font-medium"
          >Comentario adicional (opcional):</label
        >
        <textarea
          pInputTextarea
          id="comentario"
          [(ngModel)]="comentarioAdicional"
          rows="5"
          class="w-full"
          placeholder="Cuéntanos más sobre tu decisión..."
          [maxLength]="1000"
        ></textarea>
        <small class="text-500">{{ comentarioAdicional.length }}/1000</small>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <div class="flex justify-content-between gap-2">
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          (onClick)="cancelar()"
          [outlined]="true"
          severity="secondary"
        />
        <p-button
          label="Solicitar Baja"
          icon="pi pi-sign-out"
          (onClick)="abrirDialogConfirmacion()"
          severity="danger"
          [disabled]="motivosSeleccionados.length === 0"
        />
      </div>
    </ng-template>
  </p-card>
  }
</div>

<!-- Dialog de confirmación -->
<p-dialog
  header="Confirmar Baja de Suscripción"
  [(visible)]="dialogConfirmacion"
  [modal]="true"
  [style]="{ width: '500px' }"
  [draggable]="false"
  [resizable]="false"
>
  <div class="flex flex-column gap-3">
    <p class="text-lg">
      <i class="pi pi-exclamation-triangle text-orange-500 mr-2"></i>
      ¿Estás seguro de que deseas dar de baja tu suscripción?
    </p>

    <div class="p-3 surface-100 border-round">
      <p class="font-medium mb-2">Tu suscripción permanecerá activa hasta:</p>
      <p class="text-xl font-bold text-primary">
        {{ validacion?.proximoPago | date : 'dd/MM/yyyy' }}
      </p>
    </div>

    <p class="text-sm text-600">
      Una vez confirmada, tu suscripción se cancelará y no se renovará
      automáticamente. Podrás seguir disfrutando del servicio hasta la fecha
      indicada.
    </p>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button
        label="Volver"
        icon="pi pi-arrow-left"
        (onClick)="dialogConfirmacion.set(false)"
        [text]="true"
        [disabled]="procesandoBaja()"
      />
      <p-button
        label="Confirmar Baja"
        icon="pi pi-check"
        (onClick)="confirmarBaja()"
        severity="danger"
        [loading]="procesandoBaja()"
      />
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog fuera de plazo -->
<p-dialog
  header="Solicitud fuera de plazo"
  [(visible)]="dialogFueraDePlazo"
  [modal]="true"
  [style]="{ width: '550px' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="false"
>
  <div class="flex flex-column gap-3">
    <div class="flex align-items-center gap-2 mb-2">
      <i class="pi pi-info-circle text-orange-500 text-3xl"></i>
      <h3 class="m-0">No se puede procesar la solicitud</h3>
    </div>

    <p class="text-700 line-height-3">
      Te informamos de que la solicitud de baja de tu suscripción no se ha
      podido tramitar, ya que debe realizarse con al menos
      <strong>10 días de antelación</strong> a la fecha del próximo cobro.
    </p>

    <div class="p-3 surface-100 border-round">
      <div class="flex justify-content-between mb-2">
        <span class="font-medium">Próximo cobro:</span>
        <span class="font-bold">{{
          validacion?.proximoPago | date : 'dd/MM/yyyy'
        }}</span>
      </div>
      <div class="flex justify-content-between">
        <span class="font-medium">Días restantes:</span>
        <span
          class="font-bold"
          [class.text-red-500]="validacion && validacion.diasRestantes < 10"
        >
          {{ validacion?.diasRestantes }} días
        </span>
      </div>
    </div>

    <p class="text-sm text-600 line-height-3">
      En este caso, el pago ya programado se efectuará con normalidad, y tu
      solicitud quedará registrada para aplicarse al periodo siguiente.
    </p>

    <p class="text-sm text-600">
      Agradecemos tu comprensión y te recordamos que puedes contactar con
      nuestro equipo si necesitas más información o asistencia con tu
      suscripción.
    </p>

    <p class="font-medium text-center mt-2">
      Gracias por formar parte de TecnikaFire.
    </p>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-center">
      <p-button
        label="Entendido"
        icon="pi pi-check"
        (onClick)="cerrarDialogFueraDePlazo()"
      />
    </div>
  </ng-template>
</p-dialog>
