<p-confirmDialog [style]="{width: '50vw'}" [baseZIndex]="10000"></p-confirmDialog>

<div class="profile-container">
  <!-- Spinner de carga -->
  <div class="loading-container" *ngIf="isLoading$ | async">
    <ngx-spinner type="ball-scale-multiple"></ngx-spinner>
    <p>Cargando perfil...</p>
  </div>

  <div class="profile-content" *ngIf="!(isLoading$ | async) && user">
    <div class="grid">
      <!-- Informaci√≥n del perfil (lado izquierdo) -->
      <div
        class="col-12"
        [ngClass]="{
          'md:col-8': user.rol !== 'ADMIN',
          'md:col-12': user.rol === 'ADMIN'
        }"
      >
        <div class="profile-card">
          <div class="card-header">
            <h2><i class="pi pi-user-edit"></i> Mi Perfil</h2>
          </div>

          <div class="card-content">
            <div class="user-info-header mb-4">
              <div class="avatar-container">
                <app-avatar-upload
                  [avatarUrl]="user.avatarUrl"
                ></app-avatar-upload>
              </div>
              <div class="user-info-text">
                <h3>{{ user.nombre }} {{ user.apellidos }}</h3>
                <span
                  class="user-role"
                  [ngClass]="{ 'admin-role': user.rol === 'ADMIN' }"
                >
                  {{ user.rol === "ADMIN" ? "Administrador" : "Alumno" }}
                </span>
              </div>
            </div>

            <!-- Campos de formulario -->
            <div class="form-group mb-3">
              <label for="nombre">Nombre</label>
              <input
                type="text"
                pInputText
                id="nombre"
                [(ngModel)]="user.nombre"
                class="w-full"
              />
            </div>

            <div class="form-group mb-3">
              <label for="apellidos">Apellidos</label>
              <input
                type="text"
                pInputText
                id="apellidos"
                [(ngModel)]="user.apellidos"
                class="w-full"
              />
            </div>

            <div class="form-group mb-3">
              <label for="dni">DNI/NIE</label>
              <input
                type="text"
                pInputText
                id="dni"
                [(ngModel)]="user.dni"
                placeholder="Ej: 12345678Z"
                class="w-full"
              />
            </div>

            <div class="form-group mb-3">
              <label for="email">Email</label>
              <input
                type="text"
                pInputText
                id="email"
                [value]="user.email"
                disabled
                class="w-full"
              />
            </div>

            <div class="form-group mb-3">
              <label for="tutores">Tutor asignado</label>
              <p-dropdown
                id="tutores"
                styleClass="w-full"
                [options]="(tutores$ | async) ?? []"
                [(ngModel)]="user.tutorId"
                optionLabel="email"
                optionValue="id"
                appendTo="body"
                placeholder="Tutor (opcional)"
              >
                <ng-template let-item pTemplate="selectedItem">
                  <div class="flex align-items-center gap-2">
                    <div>
                      {{
                        item.nombre && item.apellidos
                          ? item.nombre + " " + item.apellidos
                          : item.email
                      }}
                    </div>
                  </div>
                </ng-template>
                <ng-template let-item let-index pTemplate="item">
                  <div class="flex align-items-center gap-2">
                    <div>
                      {{
                        item.nombre && item.apellidos
                          ? item.nombre + " " + item.apellidos
                          : item.email
                      }}
                    </div>
                  </div>
                </ng-template>
              </p-dropdown>
            </div>

            <div class="form-group mb-3">
              <app-metodo-calificacion-picker
                [(value)]="user.metodoCalificacion"
                [showClear]="false"
                label="M√©todo de calificaci√≥n"
                placeholder="Seleccione un m√©todo de calificaci√≥n"
              ></app-metodo-calificacion-picker>

              <div class="form-group mb-3" *ngIf="user.rol === 'ADMIN'">
                <label for="esTutor">Este usuario es tutor?</label>
                <p-toggleButton
                  id="esTutor"
                  [(ngModel)]="user.esTutor"
                  onLabel="S√≠"
                  offLabel="No"
                  styleClass="w-full"
                ></p-toggleButton>
              </div>

              <div
                class="planification-section mt-4"
                *ngIf="user.rol === 'ALUMNO'"
              >
                <div
                  class="assigned-planifications flex justify-content-between align-items-center"
                >
                  <ng-container
                    *ngIf="
                      countPlanificacionesAsignadas$ | async as count;
                      else noPlanificaciones
                    "
                  >
                    <label>Planificaciones asignadas:</label>
                    <span class="planification-count">{{ count }}</span>
                  </ng-container>

                  <ng-template #noPlanificaciones>
                    <div class="no-planification-message">
                      <p>No tienes planificaciones asignadas</p>
                      <p-button
                        styleClass="p-button-outlined"
                        icon="pi pi-sync"
                        label="Asignar planificaci√≥n autom√°ticamente"
                        (click)="autoAssignPlanificacion()"
                      ></p-button>
                    </div>
                  </ng-template>
                </div>
              </div>

              <!-- Botones de acci√≥n -->
              <div class="action-buttons mt-4 flex justify-content-end">
                <app-async-button
                  label="Guardar cambios"
                  icon="pi pi-save"
                  [action]="saveProfile.bind(this)"
                ></app-async-button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Informaci√≥n de suscripciones y consumibles (lado derecho) -->
      <div class="col-12 md:col-4" *ngIf="user.rol !== 'ADMIN'">
        <!-- Card de Suscripciones -->
        <div class="subscription-card">
          <div class="card-header">
            <h2><i class="pi pi-credit-card"></i> Mis Suscripciones</h2>
          </div>

          <div class="card-content">
            <!-- Si no hay suscripciones -->
            <div class="no-subscription" *ngIf="!user.suscripciones?.length">
              <i class="pi pi-info-circle"></i>
              <h3>Sin suscripci√≥n activa</h3>
              <p>No tienes ninguna suscripci√≥n activa en este momento.</p>
              <a [href]="tiendaUrl" target="_blank">
                <p-button
                  label="Obtener plan"
                  icon="pi pi-external-link"
                  styleClass="p-button-outlined mt-3"
                ></p-button>
              </a>
            </div>

            <!-- Si hay suscripciones -->
            <div
              class="subscription-details"
              *ngIf="user.suscripciones?.length"
            >
              <div
                *ngFor="let suscripcion of user.suscripciones"
                class="subscription-card-item"
                [ngClass]="{
                  'status-active':
                    suscripcion.status === 'ACTIVE' && !suscripcion.fechaFin,
                  'status-pending':
                    suscripcion.status === 'ACTIVE' && suscripcion.fechaFin,
                  'status-cancelled': suscripcion.status === 'CANCELLED'
                }"
              >
                <!-- Header con logo y nombre -->
                <div class="subscription-header">
                  <img
                    [src]="oposiciones[suscripcion.oposicion]?.image"
                    [alt]="oposiciones[suscripcion.oposicion]?.name"
                    class="subscription-logo"
                  />
                  <div class="subscription-title">
                    <span class="oposicion-name">
                      {{ oposiciones[suscripcion.oposicion]?.name }}
                    </span>
                    <span
                      class="plan-badge"
                      [ngClass]="'plan-' + suscripcion.tipo.toLowerCase()"
                    >
                      {{
                        suscripcion.tipo === "BASIC"
                          ? "B√°sico"
                          : suscripcion.tipo === "ADVANCED"
                          ? "Avanzado"
                          : "Premium"
                      }}
                    </span>
                  </div>
                  <!-- Men√∫ de opciones -->
                  <p-menu
                    #subscriptionMenu
                    [model]="getSubscriptionMenuItems(suscripcion)"
                    [popup]="true"
                    appendTo="body"
                  />
                  <button
                    class="options-btn"
                    (click)="subscriptionMenu.toggle($event)"
                    pTooltip="Opciones"
                    tooltipPosition="left"
                  >
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                </div>

                <!-- Info de la suscripci√≥n -->
                <div class="subscription-info">
                  <!-- Estado -->
                  <div class="info-row">
                    <span class="info-label">Estado</span>
                    <span
                      class="info-value"
                      [ngClass]="{
                        'text-green-600':
                          suscripcion.status === 'ACTIVE' &&
                          !suscripcion.fechaFin &&
                          !suscripcion.cancelacionProgramada,
                        'text-orange-600':
                          suscripcion.status === 'ACTIVE' &&
                          (suscripcion.fechaFin ||
                            suscripcion.cancelacionProgramada),
                        'text-red-500': suscripcion.status === 'CANCELLED'
                      }"
                    >
                      @if (suscripcion.status === 'ACTIVE' &&
                      suscripcion.cancelacionProgramada) {
                      <i class="pi pi-calendar-times mr-1"></i> Cancelaci√≥n
                      programada } @else if (suscripcion.status === 'ACTIVE' &&
                      suscripcion.fechaFin) {
                      <i class="pi pi-clock mr-1"></i> Baja pendiente } @else if
                      (suscripcion.status === 'ACTIVE') {
                      <i class="pi pi-check-circle mr-1"></i> Activo } @else {
                      <i class="pi pi-times-circle mr-1"></i> Cancelado }
                    </span>
                  </div>

                  <!-- Fecha inicio -->
                  <div class="info-row" *ngIf="suscripcion.fechaInicio">
                    <span class="info-label">Desde</span>
                    <span class="info-value">
                      {{ suscripcion.fechaInicio | date : "d MMM yyyy" }}
                    </span>
                  </div>

                  <!-- Fecha fin / renovaci√≥n -->
                  <div class="info-row" *ngIf="suscripcion.fechaFin">
                    <span class="info-label">
                      {{
                        suscripcion.status === "CANCELLED"
                          ? "Finaliz√≥"
                          : "Finaliza"
                      }}
                    </span>
                    <span
                      class="info-value"
                      [ngClass]="{
                        'text-orange-600': suscripcion.status === 'ACTIVE',
                        'text-red-500': suscripcion.status === 'CANCELLED'
                      }"
                    >
                      {{ suscripcion.fechaFin | date : "d MMM yyyy" }}
                    </span>
                  </div>

                  <!-- Cancelaci√≥n programada -->
                  <div
                    class="info-row"
                    *ngIf="suscripcion.cancelacionProgramada"
                  >
                    <span class="info-label">Se cancelar√° el</span>
                    <span class="info-value text-orange-600 font-semibold">
                      {{
                        suscripcion.cancelacionProgramada | date : "d MMM yyyy"
                      }}
                    </span>
                  </div>

                  <!-- Precio -->
                  <div class="info-row" *ngIf="suscripcion.monthlyPrice">
                    <span class="info-label">Precio</span>
                    <span class="info-value font-semibold">
                      {{ suscripcion.monthlyPrice }}‚Ç¨/mes
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <div class="subscription-actions mt-4">
              <!-- Banner sin plan activo para usuarios WP -->
              <div
                class="no-plan-banner mb-3 p-3 border-round"
                *ngIf="
                  isLinkedToWordPress() && !hasActiveWooCommerceSubscription()
                "
              >
                <div class="flex align-items-start gap-3">
                  <i class="pi pi-exclamation-triangle text-2xl"></i>
                  <div class="flex-1">
                    <h4 class="m-0 mb-2">No tienes un plan activo</h4>
                    <p class="m-0 mb-3 text-sm">
                      Para acceder a todo el contenido, necesitas contratar un
                      plan en nuestra tienda.
                    </p>
                    <p-button
                      label="Ir a la tienda"
                      icon="pi pi-external-link"
                      styleClass="p-button-sm"
                      (onClick)="abrirTiendaWordPress()"
                    ></p-button>
                  </div>
                </div>
              </div>

              <!-- Botones para usuarios WP con plan activo -->
              <div
                class="flex flex-column gap-2"
                *ngIf="isLinkedToWordPress() && hasActiveSubscription()"
              >
                <p-button
                  label="Gestionar suscripciones"
                  icon="pi pi-external-link"
                  styleClass="p-button-outlined w-full"
                  (onClick)="gestionarEnWordPress()"
                  pTooltip="Abre tu cuenta de WordPress para gestionar tus suscripciones"
                  tooltipPosition="top"
                ></p-button>
                <p-button
                  label="A√±adir m√°s planes"
                  icon="pi pi-shopping-cart"
                  styleClass="p-button-text w-full"
                  (onClick)="abrirTiendaWordPress()"
                ></p-button>
              </div>
              <!-- Aviso informativo sobre cancelaciones -->
              <div
                class="info-banner p-2 border-round mb-3"
                style="
                  background: #f0f9ff;
                  border: 1px solid #bae6fd;
                  position: relative;
                "
                *ngIf="mostrarBannerCancelacion"
              >
                <div class="flex align-items-start gap-2">
                  <i
                    class="pi pi-info-circle text-blue-500"
                    style="font-size: 0.9rem; margin-top: 2px"
                  ></i>
                  <small
                    class="text-600 flex-1"
                    style="font-size: 0.85rem; line-height: 1.4"
                  >
                    Recuerda: Las cancelaciones deben solicitarse con al menos 5
                    d√≠as de antelaci√≥n a tu pr√≥xima renovaci√≥n.
                  </small>
                  <button
                    type="button"
                    class="p-button p-button-text p-button-rounded p-button-sm"
                    (click)="cerrarBannerCancelacion()"
                    style="
                      min-width: auto;
                      padding: 0.25rem;
                      margin-left: 0.5rem;
                    "
                    pTooltip="Cerrar"
                    tooltipPosition="top"
                  >
                    <i
                      class="pi pi-times text-600"
                      style="font-size: 0.85rem"
                    ></i>
                  </button>
                </div>
              </div>

              <!-- Botones para usuarios "en negro" -->
              <div
                class="flex flex-column gap-2"
                *ngIf="!isLinkedToWordPress() && hasActiveSubscription()"
              >
                <p-button
                  label="Vincular con WordPress"
                  icon="pi pi-link"
                  styleClass="p-button-outlined w-full"
                  (onClick)="linkToWordPress()"
                  pTooltip="Vincula tu cuenta para gestionar tus suscripciones desde WordPress"
                  tooltipPosition="top"
                ></p-button>
                <small class="text-500 text-center">
                  Para a√±adir o cambiar planes, vincula tu cuenta con WordPress
                </small>
              </div>
            </div>
          </div>
        </div>

        <!-- Card de Informaci√≥n Personal / Onboarding -->
        <div class="onboarding-card mt-4" *ngIf="user.rol === Rol.ALUMNO">
          <div class="card-header">
            <h2><i class="pi pi-user-plus"></i> Informaci√≥n Personal</h2>
          </div>

          <div class="card-content">
            <div class="onboarding-status mb-3">
              <div class="completion-info">
                <div
                  class="flex justify-content-between align-items-center mb-2"
                >
                  <span class="completion-text"> Informaci√≥n completada: </span>
                  <span class="completion-percentage font-semibold">
                    {{ getOnboardingCompletionPercentage() }}%
                  </span>
                </div>
                <div class="completion-bar">
                  <div
                    class="completion-fill"
                    [style.width.%]="getOnboardingCompletionPercentage()"
                    [ngClass]="{
                      low: getOnboardingCompletionPercentage() < 30,
                      medium:
                        getOnboardingCompletionPercentage() >= 30 &&
                        getOnboardingCompletionPercentage() < 70,
                      high:
                        getOnboardingCompletionPercentage() >= 70 &&
                        getOnboardingCompletionPercentage() < 80,
                      complete: getOnboardingCompletionPercentage() >= 80
                    }"
                  ></div>
                </div>
              </div>
            </div>

            <div
              class="onboarding-help"
              *ngIf="getOnboardingCompletionPercentage() < 100"
            >
              <div class="help-message">
                <i class="pi pi-info-circle mr-2"></i>
                <span>
                  Completar esta informaci√≥n nos ayuda a personalizar tu
                  experiencia de aprendizaje
                </span>
              </div>
            </div>

            <div class="completed-message" *ngIf="isOnboardingComplete()">
              <i class="pi pi-check-circle mr-2"></i>
              <span *ngIf="getOnboardingCompletionPercentage() >= 100">
                ¬°Informaci√≥n completa! Gracias por ayudarnos a conocerte mejor.
              </span>
              <span
                *ngIf="
                  getOnboardingCompletionPercentage() >= 80 &&
                  getOnboardingCompletionPercentage() < 100
                "
              >
                ¬°Lo tienes bastante bien! Aunque todav√≠a puedes mejorar tu
                perfil completando el
                {{ 100 - getOnboardingCompletionPercentage() }}% restante.
              </span>
            </div>

            <div class="onboarding-actions mt-4">
              <p-button
                label="Completar informaci√≥n"
                icon="pi pi-pencil"
                styleClass="p-button-outlined w-full"
                (click)="openOnboardingModal()"
              ></p-button>
            </div>
          </div>
        </div>

        <!-- Card de Consumibles (Simulacros) - SIEMPRE VISIBLE -->
        <div class="subscription-card mt-4">
          <div class="card-header">
            <h2><i class="pi pi-ticket"></i> Mis Accesos</h2>
          </div>

          <div class="card-content">
            <!-- Si NO hay consumibles - Mostrar placeholder -->
            <div
              class="no-subscription"
              *ngIf="!user.consumibles || user.consumibles.length === 0"
            >
              <i class="pi pi-ticket"></i>
              <h3>Sin accesos disponibles</h3>
              <p>No tienes simulacros o accesos activos en este momento.</p>
              <a
                [href]="tiendaUrl + '?s=simulacro'"
                target="_blank"
                *ngIf="isLinkedToWordPress()"
              >
                <p-button
                  label="Ver simulacros disponibles"
                  icon="pi pi-shopping-cart"
                  styleClass="p-button-outlined mt-3"
                ></p-button>
              </a>
            </div>

            <!-- Si hay consumibles - Mostrar lista -->
            <div
              class="consumibles-list"
              *ngIf="user.consumibles && user.consumibles.length > 0"
            >
              <div
                *ngFor="let consumible of getConsumiblesActivos()"
                class="consumible-item"
                [ngClass]="{
                  'consumible-activado': consumible.estado === 'ACTIVADO',
                  'consumible-usado': consumible.estado === 'USADO',
                  'consumible-expirado': consumible.estado === 'EXPIRADO'
                }"
              >
                <!-- Header del consumible -->
                <div class="consumible-header">
                  <div class="consumible-icon">
                    <i
                      class="pi"
                      [ngClass]="{
                        'pi-ticket': consumible.estado === 'ACTIVADO',
                        'pi-check-circle': consumible.estado === 'USADO',
                        'pi-times-circle': consumible.estado === 'EXPIRADO'
                      }"
                    ></i>
                  </div>
                  <div class="consumible-info">
                    <h4
                      class="consumible-titulo"
                      [pTooltip]="
                        !consumible.examen
                          ? 'Contacta con el administrador para vincular este simulacro'
                          : ''
                      "
                      tooltipPosition="top"
                    >
                      {{
                        consumible.examen?.titulo || "Simulacro sin vincular"
                      }}
                    </h4>
                    <span
                      class="consumible-badge"
                      [ngClass]="{
                        'badge-activado': consumible.estado === 'ACTIVADO',
                        'badge-usado': consumible.estado === 'USADO',
                        'badge-expirado': consumible.estado === 'EXPIRADO',
                        'badge-sin-vincular': !consumible.examen
                      }"
                    >
                      {{
                        !consumible.examen
                          ? "Sin vincular"
                          : consumible.estado === "ACTIVADO"
                          ? "Disponible"
                          : consumible.estado === "USADO"
                          ? "Usado"
                          : "Expirado"
                      }}
                    </span>
                  </div>
                </div>

                <!-- Info adicional -->
                <div class="consumible-details">
                  <div class="detail-row">
                    <span class="detail-label">SKU:</span>
                    <span class="detail-value">{{ consumible.sku }}</span>
                  </div>

                  <div
                    class="detail-row"
                    *ngIf="consumible.examen?.codigoAcceso"
                  >
                    <span class="detail-label">C√≥digo:</span>
                    <span class="detail-value">{{
                      consumible.examen.codigoAcceso
                    }}</span>
                  </div>

                  <div class="detail-row">
                    <span class="detail-label">Tipo:</span>
                    <span class="detail-value">{{
                      getTipoConsumibleLabel(consumible.tipo)
                    }}</span>
                  </div>

                  <div
                    class="detail-row"
                    *ngIf="consumible.usadoEn && consumible.estado === 'USADO'"
                  >
                    <span class="detail-label">Usado el:</span>
                    <span class="detail-value">{{
                      consumible.usadoEn | date : "dd/MM/yyyy HH:mm"
                    }}</span>
                  </div>

                  <div class="detail-row" *ngIf="consumible.expiraEn">
                    <span class="detail-label">Expira el:</span>
                    <span class="detail-value">{{
                      consumible.expiraEn | date : "dd/MM/yyyy"
                    }}</span>
                  </div>
                </div>

                <!-- Acci√≥n -->
                <div
                  class="consumible-action"
                  *ngIf="consumible.estado === 'ACTIVADO' && consumible.examen"
                >
                  <div class="flex gap-2">
                    <!-- Bot√≥n para usar el consumible directamente -->
                    <app-async-button
                      label="Usar"
                      icon="pi pi-play"
                      styleClass="p-button-sm flex-1"
                      [action]="usarConsumible.bind(this, consumible)"
                    ></app-async-button>
                  </div>
                </div>

                <!-- Acci√≥n para consumibles sin vincular -->
                <div
                  class="consumible-action"
                  *ngIf="consumible.estado === 'ACTIVADO' && !consumible.examen"
                >
                  <div class="flex gap-2">
                    <p-button
                      label="Sin vincular"
                      icon="pi pi-link"
                      styleClass="p-button-sm p-button-outlined p-button-secondary flex-1"
                      [disabled]="true"
                      pTooltip="Este simulacro a√∫n no ha sido vinculado. Espera a que el administrador lo vincule o contacta con soporte."
                      tooltipPosition="top"
                    ></p-button>
                  </div>
                </div>

                <!-- Acci√≥n para consumibles usados -->
                <div
                  class="consumible-action"
                  *ngIf="consumible.estado === 'USADO'"
                >
                  <div class="flex gap-2">
                    <p-button
                      label="Ver resultados"
                      icon="pi pi-chart-line"
                      styleClass="p-button-sm flex-1"
                      [disabled]="!puedeVerResultados(consumible)"
                      [pTooltip]="getMensajeAccesoResultados(consumible)"
                      tooltipPosition="top"
                      (onClick)="verResultadosConsumible(consumible)"
                    ></p-button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mostrar errores -->
  <div class="error-container" *ngIf="errors.length > 0">
    <div class="error-card">
      <div class="error-list">
        <h3>Errores:</h3>
        <ul>
          <li *ngFor="let error of errors">{{ error }}</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal de onboarding -->
<p-dialog
  header="Completar ficha personal"
  [(visible)]="showOnboardingModal"
  [modal]="true"
  [style]="{ width: '90vw', maxWidth: '1000px' }"
  [draggable]="false"
  [resizable]="false"
  [maximizable]="true"
>
  <p *ngIf="firstTimeShowingOnboardingModal" class="text-center">
    La informaci√≥n que recopilamos nos permite ofrecerte un servicio m√°s
    personalizado y eficiente.
  </p>
  <app-onboarding-form
    #onboardingForm
    [initialData]="onboardingData"
    [isOptional]="true"
    [showTitle]="false"
    [showSkipButton]="false"
    (dataSubmitted)="onOnboardingUpdated($event)"
  ></app-onboarding-form>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end align-items-center">
      <div class="completion-hint" *ngIf="viewportService.isMobile()">
        <small class="text-500">
          <i class="pi pi-info-circle mr-1"></i>
          Esta informaci√≥n nos ayuda a personalizar tu experiencia de
          aprendizaje
        </small>
      </div>

      <div class="flex gap-2 justify-content-end">
        <p-button
          type="submit"
          [label]="
            isFormPartiallyFilled()
              ? 'Actualizar informaci√≥n'
              : 'Guardar informaci√≥n'
          "
          styleClass="p-button-raised"
          [disabled]="!onboardingForm?.formGroup?.valid"
          (click)="onboardingForm?.onSubmit()"
        />
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog para vincular cuenta con WordPress -->
<p-dialog
  header="Vincular cuenta"
  [(visible)]="showCambioSuscripcionDialog"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '95vw', maxWidth: '700px' }"
  (onHide)="cerrarDialogCambioSuscripcion()"
>
  <app-cambio-suscripcion
    *ngIf="showCambioSuscripcionDialog"
    [isUserLinkedToWP]="isLinkedToWordPress()"
    (cerrar)="cerrarDialogCambioSuscripcion()"
    (solicitarVinculacion)="onSolicitarVinculacionDesdeDialog()"
  ></app-cambio-suscripcion>
</p-dialog>

<!-- Dialog para Baja de Suscripci√≥n -->
<p-dialog
  header="Baja de Suscripci√≥n"
  [(visible)]="showBajaSuscripcionDialog"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '95vw', maxWidth: '1200px' }"
  (onHide)="cerrarDialogBajaSuscripcion()"
>
  <app-baja-suscripcion
    *ngIf="showBajaSuscripcionDialog"
    (cerrar)="cerrarDialogBajaSuscripcion()"
    (solicitarConfirmacion)="onSolicitarConfirmacionBaja($event)"
    (mostrarFueraDePlazo)="onFueraDePlazoBaja($event)"
  ></app-baja-suscripcion>
</p-dialog>

<!-- Dialog de Confirmaci√≥n Baja -->
<p-dialog
  header="Confirmar Baja de Suscripci√≥n"
  [(visible)]="showConfirmacionBaja"
  [modal]="true"
  [style]="{ width: '550px' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="!procesandoBaja"
>
  @if (procesandoBaja) {
  <div
    class="flex flex-column align-items-center justify-content-center gap-3"
    style="min-height: 200px"
  >
    <p-progressSpinner />
    <p class="text-lg font-medium">Procesando baja de suscripci√≥n...</p>
    <p class="text-sm text-600">Por favor, espera un momento</p>
  </div>
  } @else {
  <div class="flex flex-column gap-3">
    <p class="text-lg">
      <i class="pi pi-exclamation-triangle text-orange-500 mr-2"></i>
      ¬øEst√°s seguro de que deseas dar de baja tu suscripci√≥n?
    </p>

    <div class="p-3 surface-100 border-round">
      <p class="font-medium mb-2">Tu suscripci√≥n permanecer√° activa hasta:</p>
      <p class="text-xl font-bold text-primary">
        {{
          datosConfirmacionBaja?.validacion?.proximoPago | date : "dd/MM/yyyy"
        }}
      </p>
    </div>

    <p class="text-sm text-600">
      Una vez confirmada, tu suscripci√≥n se cancelar√° y no se renovar√°
      autom√°ticamente. Podr√°s seguir disfrutando del servicio hasta la fecha
      indicada.
    </p>

    @if (datosConfirmacionBaja?.motivos && datosConfirmacionBaja.motivos.length
    > 0) {
    <div class="mt-2">
      <p class="font-medium text-sm mb-1">Motivos seleccionados:</p>
      <div class="flex flex-wrap gap-2">
        @for (motivo of datosConfirmacionBaja.motivos; track motivo) {
        <span class="p-2 surface-100 border-round text-sm">
          {{ getMotivoLabel(motivo) }}
        </span>
        }
      </div>
    </div>
    } @if (datosConfirmacionBaja?.comentario) {
    <div class="mt-2">
      <p class="font-medium text-sm mb-1">Tu comentario:</p>
      <p class="text-sm text-600 p-2 surface-100 border-round">
        {{ datosConfirmacionBaja.comentario }}
      </p>
    </div>
    }
  </div>
  }

  <ng-template pTemplate="footer">
    @if (!procesandoBaja) {
    <div class="flex justify-content-end gap-2">
      <p-button
        label="Volver"
        icon="pi pi-arrow-left"
        (onClick)="showConfirmacionBaja = false"
        [text]="true"
        styleClass="p-button-text"
      />
      <p-button
        label="Confirmar Baja"
        icon="pi pi-check"
        (onClick)="confirmarBajaDesdePadre()"
        severity="danger"
      />
    </div>
    }
  </ng-template>
</p-dialog>

<!-- Dialog Fuera de Plazo Baja -->
<p-dialog
  header="Solicitud fuera de plazo"
  [(visible)]="showFueraDePlazoBaja"
  [modal]="true"
  [style]="{ width: '550px' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="false"
>
  <div class="flex flex-column gap-3">
    <div class="flex align-items-center gap-2 mb-2">
      <i class="pi pi-info-circle text-orange-500 text-3xl"></i>
      <h3 class="m-0">No se puede procesar la solicitud</h3>
    </div>

    <p class="text-700 line-height-3">
      Has solicitado la baja de tu suscripci√≥n con menos de
      <strong>5 d√≠as de antelaci√≥n</strong> a tu pr√≥ximo cobro.
    </p>

    <div class="p-3 surface-100 border-round">
      <div class="flex justify-content-between mb-2">
        <span class="font-medium">Pr√≥ximo cobro:</span>
        <span class="font-bold">{{
          validacionPlazo?.proximoPago | date : "dd/MM/yyyy"
        }}</span>
      </div>
      <div class="flex justify-content-between">
        <span class="font-medium">D√≠as restantes:</span>
        <span
          class="font-bold"
          [class.text-red-500]="
            validacionPlazo && validacionPlazo.diasRestantes < 5
          "
        >
          {{ validacionPlazo?.diasRestantes }} d√≠as
        </span>
      </div>
    </div>

    <div class="p-3 surface-50 border-round mt-3">
      <h4 class="mt-0 mb-2">¬øQu√© significa esto?</h4>
      <ul class="my-2 pl-3">
        <li class="mb-2">
          ‚úì Se realizar√° el cobro programado para el
          {{ validacionPlazo?.proximoPago | date : "dd/MM/yyyy" }}
        </li>
        <li class="mb-2">
          ‚úì Tu suscripci√≥n permanecer√° activa durante ese mes
        </li>
        <li class="mb-2">
          ‚úì La cancelaci√≥n se aplicar√° al <strong>siguiente periodo</strong>,
          sin m√°s cobros
        </li>
      </ul>
    </div>

    <p class="text-sm text-600 line-height-3 mt-3">
      Esta pol√≠tica nos permite gestionar adecuadamente los cobros y garantizar
      que mantengas acceso al servicio durante el periodo pagado.
    </p>

    <p class="text-sm text-600">
      Agradecemos tu comprensi√≥n y te recordamos que puedes contactar con
      nuestro equipo si necesitas m√°s informaci√≥n o asistencia con tu
      suscripci√≥n.
    </p>

    <p class="font-medium text-center mt-2">
      Gracias por formar parte de TecnikaFire.
    </p>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-between w-full">
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        (onClick)="cerrarFueraDePlazoBaja()"
        [outlined]="true"
        severity="secondary"
      />
      <p-button
        label="Programar cancelaci√≥n"
        icon="pi pi-calendar-plus"
        (onClick)="confirmarCancelacionProgramada()"
        severity="warning"
      />
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog de verificaci√≥n de contrase√±a para vincular WordPress -->
<p-dialog
  [(visible)]="showVerificacionPasswordDialog"
  [modal]="true"
  [closable]="!procesandoVinculacion"
  [closeOnEscape]="!procesandoVinculacion"
  [draggable]="false"
  [resizable]="false"
  [style]="{width: '450px'}"
  header="üîê Verificaci√≥n de seguridad"
>
  <div class="flex flex-column gap-4">
    <div class="text-center mb-2">
      <i class="pi pi-shield" style="font-size: 3rem; color: var(--primary-color);"></i>
    </div>

    <p class="m-0 text-center">
      <strong>Por tu seguridad, verifica tu identidad</strong>
    </p>

    <p class="m-0">
      Ingresa tu contrase√±a actual de la plataforma de estudio.
      Esta contrase√±a se utilizar√° para:
    </p>

    <ul class="ml-3">
      <li>‚úÖ Verificar tu identidad</li>
      <li>‚úÖ Sincronizar autom√°ticamente con WordPress</li>
    </ul>

    <div class="field">
      <label for="password-verificacion">Contrase√±a</label>
      <input
        id="password-verificacion"
        type="password"
        pInputText
        [(ngModel)]="passwordVerificacion"
        [disabled]="procesandoVinculacion"
        placeholder="Ingresa tu contrase√±a actual"
        class="w-full"
        (keyup.enter)="confirmarVinculacionConPassword()"
        autofocus
      />
      <small class="text-500">M√≠nimo 6 caracteres</small>
    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-content-end gap-2">
      <p-button
        label="Verificar y vincular"
        icon="pi pi-check"
        (onClick)="confirmarVinculacionConPassword()"
        [loading]="procesandoVinculacion"
        severity="success"
      />
    </div>
  </ng-template>
</p-dialog>

<!-- Dialog para Cambio de Oposici√≥n -->
<p-dialog
  header="Cambiar Oposici√≥n"
  [(visible)]="showCambioOposicionDialog"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  [style]="{ width: '95vw', maxWidth: '600px' }"
  (onHide)="onCambioOposicionDialogClose()"
>
  <app-cambio-oposicion
    *ngIf="showCambioOposicionDialog && suscripcionParaCambio"
    [suscripcion]="suscripcionParaCambio"
    (onClose)="onCambioOposicionDialogClose($event)"
  ></app-cambio-oposicion>
</p-dialog>
